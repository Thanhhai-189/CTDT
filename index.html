<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTĐT-SQKT 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Thư viện xử lý Word -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getApps, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .font-times { font-family: "Times New Roman", Times, serif; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cstyles cho Mục 5 */
        .level-0 { font-weight: 700; color: #1e293b; background-color: #f8fafc; text-transform: uppercase; }
        .table-input { width: 100%; text-align: center; background: transparent; border: none; outline: none; padding: 4px 0; font-size: 13px; }
        .table-input:focus { background: #eff6ff; }
        .table-input:disabled { color: #1e40af; font-weight: bold; background: #f1f5f9; cursor: not-allowed; }
        .sticky-footer { position: sticky; bottom: 0; background: #f1f5f9; z-index: 10; font-weight: bold; border-top: 2px solid #cbd5e1; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            CLO: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Description: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Assessment: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
            Materials: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/><path d="M4 20h16"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m11 17-5-5 5-5"/><path d="M18 12H6"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBen_GxaeXrll6FSRiegH-Lh1ZXY_a9jrM",
            authDomain: "ctdt-sqkt.firebaseapp.com",
            projectId: "ctdt-sqkt",
            storageBucket: "ctdt-sqkt.firebasestorage.app",
            messagingSenderId: "491495146400",
            appId: "1:491495146400:web:519534d3535d8a8d615ac5",
            measurementId: "G-NDJJCTXVN3"
        };

        const initialSyllabus = {
    id: '',
    ownerUid: '',
    ownerEmail: '',

    header: {
        schoolName: 'TRƯỜNG SĨ QUAN KTQS',
        department: 'KHOA Ô TÔ',
        city: 'Thành phố Hồ Chí Minh',
        date: '2026'
    },

    info: {
        name: '',
        code: '',
        major: 'Kỹ thuật Xe máy quân sự',
        type: 'Bắt buộc',
        prerequisites: '',
        parallel: '',
        contact: 'Bộ môn Nguyên lý Động cơ - Điện, Khoa Ô tô',
        credits: { theory: 0, practice: 0, internship: 0, total: 0 },
        hours: { classroom: 0, theory: 0, practice: 0, internship: 0, exam: 0, selfStudy: 0 }
    },

    objectives: '',
    description: '',

    clos: [{ id: 'HP1', content: '' }],

    cloMatrix: {
        plos: ['CB1.KT1', 'CB2.KT2', 'CB2.KN1', 'CB3.KN2'],
        mapping: {}
    },

    structure: [],

    // ✅ PHẦN 6 – KẾ HOẠCH GIẢNG DẠY (ĐÚNG)
    teachingPlan: {},

 // Chuyển từ mảng [ ] sang đối tượng { }
assessments: [
    { 
        examCode: 'A1.1', 
        form: 'Thường xuyên 1', 
        time: 'Trong suốt quá trình học tập học phần', 
        method: 'Kiểm tra miệng, Tính chuyên cần, Thái độ học tập', 
        criteria: 'Khả năng lĩnh hội nội dung bài học trước, độ sâu của kiến thức. Sự tiến bộ trong lĩnh hội kiến thức, rèn luyện kỹ năng; thời gian học tập, tự ôn…Lễ tiết tác phong; thực hiện chế độ nền nếp, các quy định trong học tập.', 
        clo: 'HP1', 
        weight: '10' 
    },
    { 
        examCode: 'A1.2', 
        form: 'Thường xuyên 2', 
        time: 'Trong suốt quá trình học tập học phần', 
        method: 'Kiểm tra miệng, Tính chuyên cần, Thái độ học tập', 
        criteria: 'Khả năng lĩnh hội nội dung bài học trước, độ sâu của kiến thức. Sự tiến bộ trong lĩnh hội kiến thức, rèn luyện kỹ năng; thời gian học tập, tự ôn…Lễ tiết tác phong; thực hiện chế độ nền nếp, các quy định trong học tập.', 
        clo: 'HP2', 
        weight: '10' 
    },
    { 
        examCode: 'A2.1', 
        form: 'Quá trình 1', 
        time: 'Sau khi kết thúc bài', 
        method: 'Viết', 
        criteria: 'Kiến thức', 
        clo: 'HP1, HP2', 
        weight: '20' 
    },
    { 
        examCode: 'A3.1', 
        form: 'Kết thúc', 
        time: 'Sau khi học xong học phần', 
        method: 'Vấn đáp', 
        criteria: 'Tổng hợp', 
        clo: 'HP1, HP2, HP3, HP4', 
        weight: '40' 
    }
  ],

    materials: {
        required: [''],
        reference: [''],
        equipment: ''
    },

    regulations: ''
};


        function App() {
            const [syllabus, setSyllabus] = useState(initialSyllabus);
            const [savedSyllabi, setSavedSyllabi] = useState([]);
            const [activeTab, setActiveTab] = useState('info');
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('checking...'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            
            const fbAppRef = useRef(null);
            const fbDbRef = useRef(null);
            const fbAuthRef = useRef(null);
                // Cập nhật giá trị cột nhập thủ công trong Phần 6
                const updateTeachingPlanField = (lessonKey, field, value) => {
            if (!lessonKey) return;

            setSyllabus(prev => ({
                ...prev,
                teachingPlan: {
                ...prev.teachingPlan,
                [lessonKey]: {
                    ...prev.teachingPlan?.[lessonKey],
                    [field]: value
                }
                }
            }));
            };
            
            // Nhập liệu đánh giá 
           const [assessmentPlan, setAssessmentPlan] = useState(initialSyllabus.assessmentPlan);
    const updateAssessment = (examCode, field, value) => {
    const newPlan = {
        ...assessmentPlan,
        [examCode]: {
            ...assessmentPlan[examCode],
            [field]: value
        }
    };
    setAssessmentPlan(newPlan); // Cập nhật để hiển thị ngay
    setSyllabus({...syllabus, assessmentPlan: newPlan}); // Lưu vào data tổng
};
            
            const getLessonContents = (structure, startIdx) => {
                const lessonNumber = getAutoSTT(startIdx);
                const contents = [];
                let subIndex = 1;

                for (let i = startIdx + 1; i < structure.length; i++) {
                    if (structure[i].level === 0) break;

                    if (structure[i].level === 1) {
                        contents.push(`${lessonNumber}.${subIndex} ${structure[i].title}`);
                        subIndex++;
                    }
                }

                return contents.join("\n");
            };
            const getLessonSubItems = (structure, lessonIndex) => {
            const lessonSTT = getAutoSTT(lessonIndex);

            return structure
                .map((item, idx) => ({ item, idx }))
                .filter(
                ({ item, idx }) =>
                    idx > lessonIndex &&
                    item.level > 0 &&
                    getAutoSTT(idx).startsWith(`${lessonSTT}.`)
                )
                .map(
                ({ item, idx }) => `${getAutoSTT(idx)}. ${item.title}`
                );
            };

            const getAssessmentRows = () => {
            const rows = [];

            syllabus.structure.forEach((item, idx) => {
                if (item.level !== 0 || item.isTest) return;

                const lessonKey = getAutoSTT(idx);
                const plan = syllabus.teachingPlan?.[lessonKey];
                if (!plan?.exam) return;

                rows.push({
                examCode: plan.exam,
                clo: item.clo
                });
            });

            return rows;
            };

            const fetchUserRole = async (u) => {
                if (!u) return;
                const { doc, getDoc } = window.fb;
                try {
                    const userDoc = await getDoc(doc(fbDbRef.current, 'users', u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const role = data.role || data.Role || 'guest';
                        setUserRole(role.toString().toLowerCase());
                    } else setUserRole('guest');
                } catch (e) { setUserRole('guest'); }
            };

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const { initializeApp, getApps, getAuth, onAuthStateChanged, getFirestore } = window.fb;
                        if (!fbAppRef.current) {
                            fbAppRef.current = getApps().length > 0 ? getApps()[0] : initializeApp(FIREBASE_CONFIG);
                            fbDbRef.current = getFirestore(fbAppRef.current);
                            fbAuthRef.current = getAuth(fbAppRef.current);
                        }
                        onAuthStateChanged(fbAuthRef.current, async (u) => {
                            setUser(u);
                            if (u) await fetchUserRole(u);
                            else setUserRole('guest');
                            setLoading(false);
                        });
                    } catch (e) { setLoading(false); }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !fbDbRef.current) return;
                const { collection, onSnapshot } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const q = collection(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSavedSyllabi(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [user]);

            
            const handleLogin = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.fb;
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(fbAuthRef.current, provider); } catch (e) { alert(e.message); }
            };

            const isAdmin = userRole === 'admin';
            const isEditor = userRole === 'editor';
            const isOwner = syllabus.ownerUid === user?.uid || syllabus.ownerUid === ''; 
            const canEditThis = isAdmin || (isEditor && isOwner);

            const handleCreditChange = (field, value) => {
                const val = Math.max(0, parseFloat(value) || 0);
                setSyllabus(prev => {
                    const newCredits = { ...prev.info.credits, [field]: val };
                    newCredits.total = (newCredits.theory || 0) + (newCredits.practice || 0) + (newCredits.internship || 0);
                    
                    const hTheory = newCredits.theory * 15;
                    const hPractice = newCredits.practice * 30;
                    const hInternship = newCredits.internship * 45;
                    
                    const newHours = { 
                        ...prev.info.hours,
                        theory: hTheory,
                        practice: hPractice + hInternship,
                        classroom: hTheory + hPractice + hInternship,
                        selfStudy: newCredits.total * 30 
                    };
                    
                    return { ...prev, info: { ...prev.info, credits: newCredits, hours: newHours } };
                });
            };

            // Thành phần Stepper để điều chỉnh số tín chỉ
            const CreditStepper = ({ label, field, value }) => (
                <div className="space-y-1">
                    <label className="text-[10px] font-bold text-slate-500 uppercase">{label}</label>
                    <div className="flex items-center gap-1 bg-white border border-blue-200 rounded-lg overflow-hidden h-10 shadow-sm">
                        <button onClick={() => handleCreditChange(field, value - 1)} disabled={!canEditThis} className="w-10 h-full hover:bg-red-50 text-red-600 border-r border-blue-100 font-bold disabled:opacity-30">-</button>
                        <div className="flex-1 text-center font-bold text-sm text-blue-700">{value}</div>
                        <button onClick={() => handleCreditChange(field, value + 1)} disabled={!canEditThis} className="w-10 h-full hover:bg-emerald-50 text-emerald-600 border-l border-blue-100 font-bold disabled:opacity-30">+</button>
                    </div>
                </div>
            );

            const saveToCloud = async () => {
                if (!user) return alert("Vui lòng đăng nhập.");
                if (!canEditThis) return alert("Không có quyền chỉnh sửa.");
                if (!syllabus.info.code) return alert("Nhập Mã học phần.");
                setIsSaving(true);
                const { doc, setDoc } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const dataToSave = { ...syllabus, ownerUid: syllabus.ownerUid || user.uid, ownerEmail: syllabus.ownerEmail || user.email };
                try {
                    await setDoc(doc(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi', syllabus.info.code), { ...dataToSave, id: syllabus.info.code, updatedAt: new Date().toISOString() });
                    alert("Đã lưu!");
                    setSyllabus(dataToSave);
                } catch (e) { alert(e.message); }
                setIsSaving(false);
            };

            const handleDuplicate = () => {
                if (!user) return alert("Vui lòng đăng nhập Gmail để nhân bản.");
                if (!isAdmin && !isEditor) return alert("Bạn không có quyền thực hiện chức năng này.");
                if (!syllabus.info.code) return alert("Học phần hiện tại chưa có thông tin để nhân bản.");

                const duplicatedSyllabus = JSON.parse(JSON.stringify(syllabus));
                duplicatedSyllabus.id = ''; 
                duplicatedSyllabus.info.code = `${duplicatedSyllabus.info.code}-copy`;
                duplicatedSyllabus.ownerUid = user.uid;
                duplicatedSyllabus.ownerEmail = user.email;

                setSyllabus(duplicatedSyllabus);
                alert("Đã nhân bản thành công! Bạn hiện là chủ sở hữu bản sao này.");
            };

            // 1. Định nghĩa một hàm helper nhỏ để xử lý hiển thị số
            const formatNum = (val) => {
                const num = parseFloat(val);
                // Nếu không phải là số, hoặc bằng 0, hoặc null/undefined thì trả về chuỗi rỗng
                if (isNaN(num) || num === 0) return "";
                // Trả về chuỗi (giữ nguyên phần thập phân nếu có)
                return num.toString().replace('.', ','); 
            };

const insertAssessmentRowAfter = (index) => {
    const newRow = {
        form: '',
        examCode: '',
        time: '',
        method: '',
        criteria: '',
        clo: '',
        weight: ''
    };

    setSyllabus(prev => {
        const next = [...(prev.assessments || [])];
        next.splice(index + 1, 0, newRow);
        return { ...prev, assessments: next };
    });
};

const removeAssessmentRow = (index) => {
    setSyllabus(prev => {
        if (!prev.assessments || prev.assessments.length <= 1) {
            return prev; // ❌ Không cho xóa hàng duy nhất
        }

        return {
            ...prev,
            assessments: prev.assessments.filter((_, i) => i !== index)
        };
    });
};


const updateAssessmentRow = (index, field, value) => {
    setSyllabus(prev => {
        const next = [...prev.assessments];
        next[index] = { ...next[index], [field]: value };
        return { ...prev, assessments: next };
    });
};


const exportWord = async () => {
    const { Document, Packer, Paragraph, TextRun, AlignmentType, Table, TableRow, TableCell, WidthType, BorderStyle, VerticalAlign } = window.docx;

    const createMultiLineCell = (lines, options = {}) =>
  new TableCell({
    width: options.width,
    verticalAlign: VerticalAlign.CENTER,
    children: (Array.isArray(lines) ? lines : [lines]).map(line =>
      tablePara(line)
    )
  });


    // --- CẤU HÌNH ĐỊNH DẠNG CHUẨN SQKT ---
    // font: Times New Roman
    // size: 28 (docx dùng half-points, 14pt * 2 = 28)
    // alignment: Justified (Căn đều hai bên)
    // spacing: before/after 6pt (120 twips), line spacing single (240 twips)
    // indent: firstLine 1cm (~567 twips)
    const STYLES = {
        font: "Times New Roman",
        size: 28, 
        alignment: AlignmentType.JUSTIFIED,
        spacing: { before: 120, after: 120, line: 240 }, 
        indent: { firstLine: 567 } 
    };

    // =====================
// 2. PARAGRAPH CHUẨN
// =====================

// Ngoài bảng
const textPara = (text, extra = {}) =>
  new Paragraph({
    alignment: STYLES.alignment,
    spacing: STYLES.spacing,
    indent: STYLES.indent,
    children: [
      new TextRun({
        text,
        font: STYLES.font,
        size: STYLES.size,
        ...extra
      })
    ]
  });

// Trong bảng
const tablePara = (text, extra = {}) =>
  new Paragraph({
    spacing: { before: 60, after: 60, line: 360 },
    children: [
      new TextRun({
        text,
        font: STYLES.font,
        size: STYLES.size,
        ...extra
      })
    ]
  });

// =====================
// 3. TABLE CELL CHUẨN
// =====================
const createTableCell = (lines, width, bold = false) =>
  new TableCell({
    width,
    verticalAlign: VerticalAlign.CENTER,
    children: (Array.isArray(lines) ? lines : [lines]).map(
      line => tablePara(line, bold ? { bold: true } : {})
    )
  });
    // Hàm tiện ích tạo ô trong bảng
    const createCell = (text, options = {}) => new TableCell({
        children: [new Paragraph({ 
            children: [new TextRun({ text: text || "", bold: options.bold, size: STYLES.size, font: STYLES.font })],
            alignment: options.alignment || AlignmentType.CENTER
        })],
        verticalAlign: VerticalAlign.CENTER,
        shading: options.shading,
        width: options.width,
        borders: options.borders
    });

    // Hàm tiện ích tạo đoạn văn bản có thụt lề 1cm và định dạng chuẩn
    const createTextPara = (text, options = {}) => new Paragraph({
        children: [new TextRun({ text: text || "", bold: options.bold, italic: options.italic, size: STYLES.size, font: STYLES.font })],
        alignment: options.alignment || STYLES.alignment,
        spacing: options.spacing || STYLES.spacing,
        indent: options.noIndent ? undefined : (options.indent || STYLES.indent)
    });

    const sections = [];
    // Tính tổng cột KT (Kiểm tra, thi) từ mảng structure
const totalKT = syllabus.structure.reduce((sum, item) => {
    // Chỉ cộng các hàng ở mức độ nhỏ nhất (không phải hàng cha có chứa con)
    // Hoặc cộng tất cả nếu logic của bạn cho phép nhập trực tiếp
    return sum + (parseInt(item.kt) || 0);
}, 0);

// 1. PHẦN TIÊU ĐỀ (Sử dụng Table để căn lề chuẩn 2 bên)
const headerTable = new Table({
    width: { size: 100, type: WidthType.PERCENTAGE },
    borders: {
        top: { style: BorderStyle.NONE },
        bottom: { style: BorderStyle.NONE },
        left: { style: BorderStyle.NONE },
        right: { style: BorderStyle.NONE },
        insideHorizontal: { style: BorderStyle.NONE },
        insideVertical: { style: BorderStyle.NONE },
    },
    rows: [
        new TableRow({
            children: [
                // Cột bên trái: Tên trường và khoa
                new TableCell({
                    width: { size: 45, type: WidthType.PERCENTAGE },
                    children: [
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ 
                                    text: syllabus.header?.schoolName?.toUpperCase() || "TRƯỜNG SĨ QUAN KTQS", 
                                    bold: true, size: 24, font: STYLES.font 
                                }),
                            ],
                        }),
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ 
                                    text: syllabus.header?.department?.toUpperCase() || "KHOA Ô TÔ", 
                                    bold: true, size: 24, font: STYLES.font 
                                }),
                            ],
                        }),
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ text: "----------", bold: true, size: 24, font: STYLES.font }),
                            ],
                        }),
                    ],
                }),
                // Cột bên phải: Quốc hiệu và Tiêu ngữ
                // Cột bên phải: Quốc hiệu, Tiêu ngữ và Ngày tháng
                new TableCell({
                    width: { size: 55, type: WidthType.PERCENTAGE },
                    children: [
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ 
                                    text: "CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM", 
                                    bold: true, size: 24, font: STYLES.font 
                                }),
                            ],
                        }),
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ 
                                    text: "Độc lập - Tự do - Hạnh phúc", 
                                    bold: true, size: 24, font: STYLES.font 
                                }),
                            ],
                        }),
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            children: [
                                new TextRun({ 
                                    text: "_______________", 
                                    bold: true, size: 24, font: STYLES.font 
                                }),
                            ],
                        }),
                        // DÒNG MỚI THÊM: Thành phố Hồ Chí Minh...
                        new Paragraph({
                            alignment: AlignmentType.CENTER,
                            spacing: { before: 120 }, // Tạo một khoảng cách nhỏ với dòng kẻ trên
                            children: [
                                new TextRun({ 
                                    text: "Thành phố Hồ Chí Minh, ngày      tháng        năm 2026", 
                                    italic: true, // In nghiêng
                                    size: 24, 
                                    font: STYLES.font 
                                }),
                            ],
                        }),
                    ],
                }),
            ],
        }),
    ],
});

// Đưa vào mảng sections
sections.push(headerTable);

// Khoảng cách sau tiêu đề đầu trang
sections.push(new Paragraph({ text: "", spacing: { before: 200, after: 200 } }));

// 2. TÊN ĐỀ CƯƠNG HỌC PHẦN
sections.push(
    new Paragraph({
        alignment: AlignmentType.CENTER,
        spacing: { before: 200, after: 200 },
        children: [
            new TextRun({ 
                text: "ĐỀ CƯƠNG HỌC PHẦN", 
                bold: true, 
                size: 32, 
                font: STYLES.font 
            })
        ],
    })
);

// Thêm một dòng trống sau tên đề chương
sections.push(new Paragraph({ text: "", spacing: { after: 200 } }));
    // 2. MỤC I: THÔNG TIN CHUNG ĐỀ CƯƠNG HỌC PHẦN
    sections.push(
        new Paragraph({ children: [new TextRun({ text: "I. THÔNG TIN CHUNG ĐỀ CƯƠNG HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
        createTextPara(`Học phần: ${syllabus.info.name}`),
        createTextPara(`Mã học phần: ${syllabus.info.code}`),
        createTextPara(`Chuyên ngành: ${syllabus.info.major}`),
        createTextPara(`Loại học phần: ${syllabus.info.type}`),
        createTextPara(`Học phần trước: ${syllabus.info.prerequisites || "Không"}`),
        createTextPara(`Học phần song hành: ${syllabus.info.parallel || "Không"}`),
        createTextPara(`Số tín chỉ: ${syllabus.info.credits.total}`),
        createTextPara(`Số tiết: `),
        createTextPara(`- Số tiết lên lớp: ${syllabus.info.hours.classroom}`, { indent: { left: 708 } }),
        createTextPara(`+ Lý thuyết: ${syllabus.info.hours.theory}`, { indent: { left: 1134 } }),
        createTextPara(`+ Thực hành, thí nghiệm, bài tập, thảo luận: ${syllabus.info.hours.practice}`, { indent: { left: 1134 } }),
        createTextPara(`- Thi, kiểm tra kết thúc: ${totalKT} `, { indent: { left: 708 } }),
        createTextPara(`- Số tiết tự học: ${syllabus.info.hours.selfStudy}`, { indent: { left: 708 } }),
        createTextPara(`Bộ môn, khoa tham gia giảng dạy: ${syllabus.info.contact}`),
        
            );

    // 3. MỤC II: MỤC TIÊU
    sections.push(
        new Paragraph({ children: [new TextRun({ text: "II. MỤC TIÊU", bold: true, size: STYLES.size, font: STYLES.font })] }),
        createTextPara(syllabus.objectives || "Chưa nhập thông tin."),
        new Paragraph({ text: "" })
    );

    // 4. MỤC III: CHUẨN ĐẦU RA & MA TRẬN
    sections.push(
        new Paragraph({ children: [new TextRun({ text: "III. CHUẨN ĐẦU RA", bold: true, size: STYLES.size, font: STYLES.font })] }),
        ...syllabus.clos.map(c => 
            new Paragraph({
                children: [
                    new TextRun({ 
                        text: `${c.id}. `, // Ví dụ: HP 1. 
                        size: STYLES.size, 
                        font: STYLES.font 
                    }),
                    new TextRun({ 
                        text: c.content, // Nội dung chuẩn đầu ra
                        size: STYLES.size, 
                        font: STYLES.font 
                    })
                ],
                alignment: AlignmentType.JUSTIFY,
                spacing: { after: 120 } // Khoảng cách giữa các dòng CLO
            })
        ),
        new Paragraph({ text: "", spacing: { before: 200 } }),
        createTextPara("Bảng đóng góp của chuẩn đầu ra học phần đối với chuẩn đầu ra CTĐT:", ),
        new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
                new TableRow({
                    children: [
                        createCell("Chuẩn đầu ra học phần", { bold: true }),
                        ...syllabus.cloMatrix.plos.map(p => createCell(p, { bold: true }))
                    ]
                }),
...syllabus.clos.map(c =>
    new TableRow({
        children: [
            createCell((c.id || "").toUpperCase(), { bold: true }),

            ...syllabus.cloMatrix.plos.map(p =>
                createCell(
                    (syllabus.cloMatrix.mapping[c.id]?.[p] || "").toUpperCase()
                )
            )
        ]
    })
),
                new TableRow({
                    children: [
                        createCell(syllabus.info.name || "Chưa nhập thông tin.", { bold: true }),
                        ...syllabus.cloMatrix.plos.map(p => createCell(calculatePloSummary(p), { bold: true }))
                    ]
                })
            ]
        }),
        new Paragraph({ text: "" })
    );

    // 5. MỤC IV: MÔ TẢ HỌC PHẦN
    sections.push(
        new Paragraph({ children: [new TextRun({ text: "IV. MÔ TẢ", bold: true, size: STYLES.size, font: STYLES.font })] }),
        createTextPara(syllabus.description || "Chưa nhập thông tin."),
        new Paragraph({ text: "" })
    );

sections.push(
    new Paragraph({ children: [new TextRun({ text: "V. CẤU TRÚC HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
    new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        rows: [
            new TableRow({
                children: [
                    createCell("STT", { bold: true, width: { size: 5, type: WidthType.PERCENTAGE } }),
                    createCell("Nội dung", { bold: true, width: { size: 35, type: WidthType.PERCENTAGE } }),
                    createCell("CĐR", { bold: true, width: { size: 10, type: WidthType.PERCENTAGE } }),
                    createCell("Số tiết", { bold: true, width: { size: 5, type: WidthType.PERCENTAGE } }),
                    createCell("LT", { bold: true }), createCell("TL", { bold: true }),
                    createCell("THN", { bold: true }), createCell("THĐ", { bold: true }),
                    createCell("BT", { bold: true }), createCell("KT", { bold: true }),
                    createCell("...", { bold: true }), createCell("Học liệu", { bold: true })
                ]
            }),
            ...syllabus.structure.map((it, idx) => new TableRow({
                children: [
                    createCell(it.isTest ? "*" : getAutoSTT(idx)),
                    createCell(it.title, { alignment: AlignmentType.LEFT, bold: it.level === 0 }),
                    createCell((it.level === 0 || it.isTest) ? it.clo : "-"),
                    // Sử dụng hàm formatNum cho tất cả các ô số liệu
                    createCell(formatNum(calculateRowTotal(idx))),
                    createCell(formatNum(getAggregatedValue(idx, 'lt'))),
                    createCell(formatNum(getAggregatedValue(idx, 'tl'))),
                    createCell(formatNum(getAggregatedValue(idx, 'thn'))),
                    createCell(formatNum(getAggregatedValue(idx, 'thd'))),
                    createCell(formatNum(getAggregatedValue(idx, 'bt'))),
                    createCell(formatNum(getAggregatedValue(idx, 'kt'))),
                    createCell(formatNum(getAggregatedValue(idx, 'extra'))),
                    createCell(it.level === 0 ? (it.material || []).join(", ") : "")
                ]
            }))
        ]
    }),
    new Paragraph({ text: "" })
);
// 7. MỤC VI: KẾ HOẠCH DẠY HỌC CHI TIẾT
sections.push(
  new Paragraph({
    children: [
      new TextRun({
        text: "VI. KẾ HOẠCH VÀ PHƯƠNG PHÁP DẠY HỌC",
        bold: true,
        font: STYLES.font,
        size: STYLES.size
      })
    ]
  }),

  new Table({
    width: { size: 100, type: WidthType.PERCENTAGE },
    rows: [
      // HEADER
      new TableRow({
        children: [
          createCell("Bài học\n(số tiết)", { bold: true, width: { size: 15, type: WidthType.PERCENTAGE } }),
          createCell("Nội dung", { bold: true, width: { size: 30, type: WidthType.PERCENTAGE } }),
          createCell("CĐR", { bold: true, width: { size: 10, type: WidthType.PERCENTAGE } }),
          createCell("Hoạt động dạy\n(Giảng viên)", { bold: true, width: { size: 20, type: WidthType.PERCENTAGE } }),
          createCell("Hoạt động học\n(Học viên)", { bold: true, width: { size: 20, type: WidthType.PERCENTAGE } }),
          createCell("KT, thi", { bold: true, width: { size: 5, type: WidthType.PERCENTAGE } })
        ]
      }),

      // BODY
      ...syllabus.structure
        .map((item, idx) => {
          if (item.level !== 0 || item.isTest) return null;

          const lesson = getAutoSTT(idx);
          const plan = syllabus.teachingPlan?.[lesson] || {};

          // Gom toàn bộ mục con 1.1, 1.2, 1.3...
          const subContents = syllabus.structure
            .filter((x, i) => i > idx && x.level > 0 && getAutoSTT(i).startsWith(`${lesson}.`))
            .map(x => `${getAutoSTT(syllabus.structure.indexOf(x))}. ${x.title}`);

          return new TableRow({
            children: [
              createMultiLineCell(
                [`Bài ${lesson}`, `(${calculateRowTotal(idx)} tiết)`],
                { width: { size: 15, type: WidthType.PERCENTAGE } }
              ),

              createMultiLineCell(
                [`${item.title}`, ...subContents],
                { width: { size: 30, type: WidthType.PERCENTAGE } }
              ),

              createMultiLineCell(
                [item.clo || ""],
                { width: { size: 10, type: WidthType.PERCENTAGE } }
              ),

              createMultiLineCell(
                (plan.instructor || "").split("\n"),
                { width: { size: 20, type: WidthType.PERCENTAGE } }
              ),

              createMultiLineCell(
                (plan.student || "").split("\n"),
                { width: { size: 20, type: WidthType.PERCENTAGE } }
              ),

              createMultiLineCell(
                [plan.exam || ""],
                { width: { size: 5, type: WidthType.PERCENTAGE } }
              )
            ]
          });
        })
        .filter(Boolean)
    ]
  }),

  new Paragraph({ text: "" })
);

// 7. MỤC VII: ĐÁNH GIÁ KẾT QUẢ HỌC TẬP
sections.push(
    new Paragraph({
        children: [
            new TextRun({
                text: "VII. ĐÁNH GIÁ KẾT QUẢ HỌC TẬP",
                bold: true,
                font: STYLES.font,
                size: STYLES.size
            })
        ]
    }),

    new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        rows: [
            // HEADER
            new TableRow({
                children: [
                    createCell("Hình thức đánh giá", { bold: true, width: { size: 15, type: WidthType.PERCENTAGE } }),
                    createCell("Mã", { bold: true, width: { size: 8, type: WidthType.PERCENTAGE } }),
                    createCell("Thời điểm đánh giá", { bold: true, width: { size: 15, type: WidthType.PERCENTAGE } }),
                    createCell("Phương pháp đánh giá", { bold: true, width: { size: 22, type: WidthType.PERCENTAGE } }),
                    createCell("Tiêu chí đánh giá", { bold: true, width: { size: 22, type: WidthType.PERCENTAGE } }),
                    createCell("Đáp ứng CĐR", { bold: true, width: { size: 10, type: WidthType.PERCENTAGE } }),
                    createCell("Tỉ lệ (%)", { bold: true, width: { size: 8, type: WidthType.PERCENTAGE } })
                ]
            }),

            // BODY: Duyệt trực tiếp từ mảng syllabus.assessments
            ...(syllabus.assessments || []).map((row) => {
                return new TableRow({
                    children: [
                        // Cột 1: Hình thức (Tách dòng theo \n nếu có)
                        createMultiLineCell((row.form || "").split("\n"), { width: { size: 15, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 2: Mã
                        createCell(row.examCode || "", { width: { size: 8, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 3: Thời điểm
                        createMultiLineCell((row.time || "").split("\n"), { width: { size: 15, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 4: Phương pháp
                        createMultiLineCell((row.method || "").split("\n"), { width: { size: 22, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 5: Tiêu chí
                        createMultiLineCell((row.criteria || "").split("\n"), { width: { size: 22, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 6: Đáp ứng CĐR (Lấy giá trị thủ công từ row.clo)
                        createCell(row.clo || "", { width: { size: 10, type: WidthType.PERCENTAGE } }),
                        
                        // Cột 7: Tỉ lệ
                        createCell(row.weight || "", { width: { size: 8, type: WidthType.PERCENTAGE }, alignment: AlignmentType.CENTER })
                    ]
                });
            })
        ]
    }),

    new Paragraph({ text: "" })
);
    



// Hàm thêm 1 section đầy đủ vào document
const addFullSection = (num, title, contentParas) => {
    // Tiêu đề section
    sections.push(
        new Paragraph({
            children: [
                new TextRun({
                    text: `${num}. ${title}`,
                    bold: true,
                    size: STYLES.size,
                    font: STYLES.font,
                }),
            ],
        })
    );

    // Thêm nội dung từng paragraph
    contentParas.forEach((para) => {
        sections.push(createTextPara(para.text, para.options));
    });

    // Thêm paragraph trống để ngắt section
    sections.push(new Paragraph({ text: "" }));
};

// --- Tạo nội dung section VIII ---
const materialContentParas = [];

let counter = 1; // Biến đếm số thứ tự

// 1. Học liệu bắt buộc
materialContentParas.push({ text: "1. Học liệu bắt buộc:", options: { bold: true } });
(syllabus.materials?.required || []).forEach((item) => {
    materialContentParas.push({ text: `[${counter}] ${item}` });
    counter++;
});

// 2. Học liệu tham khảo
materialContentParas.push({ text: "2. Học liệu tham khảo:", options: { bold: true } });
(syllabus.materials?.reference || []).forEach((item) => {
    materialContentParas.push({ text: `[${counter}] ${item}` });
    counter++;
});

// 3. Vật chất / Thiết bị
materialContentParas.push({ text: "3. Vật chất:", options: { bold: true } });
if (syllabus.materials?.equipment?.trim()) {
    syllabus.materials.equipment
        .split(/\n|;/) // hỗ trợ xuống dòng hoặc ;
        .map(x => x.trim())
        .filter(Boolean)
        .forEach(item => {
            materialContentParas.push({
                text: `- ${item}`
            });
        });
        } else {
    materialContentParas.push({
        text: ""
    });}

// Thêm section VIII vào document
addFullSection("VIII", "CƠ SỞ VẬT CHẤT, HỌC LIỆU", materialContentParas);


// 9. MỤC IX: QUY ĐỊNH CỦA HỌC PHẦN
sections.push(
    new Paragraph({ 
        children: [new TextRun({ 
            text: "IX. QUY ĐỊNH CỦA HỌC PHẦN", 
            bold: true, 
            size: STYLES.size, 
            font: STYLES.font 
        })] 
    }),
    createTextPara(syllabus.regulations || "Chưa nhập thông tin."),
    new Paragraph({ text: "" })
);





    // 8. PHẦN CHỮ KÝ (CHỈ CHỦ NHIỆM KHOA VÀ TRƯỞNG BỘ MÔN)
    sections.push(
        new Paragraph({ text: "", spacing: { before: 800 } }),
        new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE }, insideHorizontal: { style: BorderStyle.NONE }, insideVertical: { style: BorderStyle.NONE } },
            rows: [
                new TableRow({
                    children: [
                        createCell("CHỦ NHIỆM KHOA", { bold: true, alignment: AlignmentType.CENTER }),
                        createCell("TRƯỞNG BỘ MÔN", { bold: true, alignment: AlignmentType.CENTER })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph({ text: "", spacing: { before: 1500 } })] }),
                        new TableCell({ children: [new Paragraph({ text: "", spacing: { before: 1500 } })] })
                    ]
                })
            ]
        })
    );

    // TẠO VÀ TẢI FILE
    const docObj = new Document({
        sections: [{
            properties: { page: { margin: { top: 720, bottom: 720, left: 1440, right: 720 } } },
            children: sections
        }]
    });

    Packer.toBlob(docObj).then(blob => {
        saveAs(blob, `De_cuong_HP_${syllabus.info.code || 'Export'}.docx`);
    });
};

            const calculatePloSummary = (ploName) => {
                const levelsRank = { "": 0, "I": 1, "R": 2, "M": 3 };
                let maxLevelNum = 0;
                let hasAssessment = false;

                syllabus.clos.forEach(clo => {
                    const cellValue = (syllabus.cloMatrix.mapping[clo.id]?.[ploName] || "").toUpperCase().trim();
                    if (!cellValue) return;

                    if (cellValue.includes("A")) hasAssessment = true;
                    
                    if (cellValue.includes("M")) maxLevelNum = Math.max(maxLevelNum, 3);
                    else if (cellValue.includes("R")) maxLevelNum = Math.max(maxLevelNum, 2);
                    else if (cellValue.includes("I")) maxLevelNum = Math.max(maxLevelNum, 1);
                });

                const levelMap = { 0: "", 1: "I", 2: "R", 3: "M" };
                const baseLevel = levelMap[maxLevelNum];

                if (baseLevel && hasAssessment) return `${baseLevel}, A`;
                if (baseLevel) return baseLevel;
                if (hasAssessment) return "A";
                return "";
            };

            const hasChildren = (index) => {
                const item = syllabus.structure[index];
                if (!item || index === syllabus.structure.length - 1) return false;
                return (syllabus.structure[index + 1]?.level || 0) > item.level;
            };

            const getAggregatedValue = (idx, field) => {
                const item = syllabus.structure[idx];
                if (!item) return 0;
                const children = [];
                for (let i = idx + 1; i < syllabus.structure.length; i++) {
                    const nextItem = syllabus.structure[i];
                    if (nextItem.level <= item.level) break;
                    if (nextItem.level === item.level + 1) children.push(i);
                }
                if (children.length === 0) return item[field] || 0;
                return children.reduce((sum, childIdx) => sum + getAggregatedValue(childIdx, field), 0);
            };

            const getAutoSTT = (index) => {
                const item = syllabus.structure[index];
                if (!item) return "";
                if (item.isTest) return "*";
                let bài = 0, mục = 0, tiểuMục = 0;
                for (let i = 0; i <= index; i++) {
                    const current = syllabus.structure[i];
                    if (current.isTest) continue;
                    if (current.level === 0) { bài++; mục = 0; tiểuMục = 0; }
                    else if (current.level === 1) { mục++; tiểuMục = 0; }
                    else if (current.level === 2) { tiểuMục++; }
                }
                if (item.level === 0) return bài.toString();
                if (item.level === 1) return `${bài}.${mục}`;
                return `${bài}.${mục}.${tiểuMục}`;
            };

            const calculateRowTotal = (idx) => {
                const fields = ['lt', 'tl', 'thn', 'thd', 'bt', 'kt', 'extra'];
                return fields.reduce((sum, field) => sum + getAggregatedValue(idx, field), 0);
            };

            const calculateGrandTotal = (field) => {
                return syllabus.structure.reduce((sum, item, idx) => {
                    if (item.level === 0) {
                        if (field === 'total') return sum + calculateRowTotal(idx);
                        return sum + getAggregatedValue(idx, field);
                    }
                    return sum;
                }, 0);
            };

            const updateStructureField = (index, field, value) => {
                const n = [...syllabus.structure];
                n[index][field] = value;
                setSyllabus({ ...syllabus, structure: n });
            };

            const changeLevel = (index, delta) => {
                const n = [...syllabus.structure];
                n[index].level = Math.max(0, Math.min(2, (n[index].level || 0) + delta));
                setSyllabus({ ...syllabus, structure: n });
            };

            const insertRowAfter = (idx) => {
            const newRow = {
                level: syllabus.structure[idx].level, // kế thừa level
                title: '',
                clo: syllabus.structure[idx].clo || 'HP1',
                isTest: false,
                lt: 0, tl: 0, thn: 0, thd: 0, bt: 0, kt: 0, extra: 0,
                material: []
            };

            const newStructure = [...syllabus.structure];
            newStructure.splice(idx + 1, 0, newRow);

            setSyllabus({ ...syllabus, structure: newStructure });
            };


            const getAvailableMaterials = () => {
                const res = [];
                const reqCount = (syllabus.materials?.required || []).length;
                const refCount = (syllabus.materials?.reference || []).length;
                for (let i = 1; i <= reqCount + refCount; i++) {
                    res.push(`[${i}]`);
                }
                return res;
            };

            if (loading) return <div className="h-screen flex items-center justify-center italic text-slate-500 animate-pulse">Chương trình đang khởi động...</div>;

            return (
                <div className="flex h-screen bg-slate-100 font-inter text-sm select-none">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shrink-0 overflow-hidden shadow-2xl">
                        <div className="p-6 border-b border-slate-800 flex items-center justify-between gap-4">
                        {/* Logo bên trái */}
                        <img src="logo.png" alt="Logo" className="h-12 w-auto" />

                        {/* Tiêu đề */}
                        <h1 className="font-bold text-lg text-blue-400 uppercase tracking-tighter">
                            CTĐT-SQKT
                        </h1>
                        </div>

                        <nav className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
                            <div className="flex flex-col gap-1 mb-6">
                                {[
                                    { id: 'info', label: '1. Thông tin chung', icon: Icons.Info },
                                    { id: 'objectives', label: '2. Mục tiêu', icon: Icons.Target },
                                    { id: 'clos', label: '3. Chuẩn đầu ra', icon: Icons.CLO },
                                    { id: 'description', label: '4. Mô tả', icon: Icons.Description },
                                    { id: 'structure', label: '5. Cấu trúc', icon: Icons.Layers },
                                    { id: 'teaching', label: '6. Kế hoạch', icon: Icons.Calendar },
                                    { id: 'assessment', label: '7. Đánh giá', icon: Icons.Assessment },
                                    { id: 'materials', label: '8. Tài liệu', icon: Icons.Materials },
                                    { id: 'regulations', label: '9. Quy định', icon: Icons.User }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl text-sm font-medium transition-all ${activeTab === tab.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>
                                        <tab.icon /> {tab.label}
                                    </button>
                                ))}
                            </div>
                            
                            <div className="pt-4 border-t border-slate-800 space-y-2">
                                <h3 className="text-[10px] text-slate-500 uppercase font-bold mb-2 px-2 tracking-widest">Danh sách học phần</h3>
                                {savedSyllabi.map(s => (
                                    <div key={s.id} onClick={() => setSyllabus(s)} className={`group relative p-3 rounded-xl cursor-pointer border text-xs transition-all ${syllabus.id === s.id ? 'bg-slate-800 border-blue-500 shadow-inner' : 'border-transparent hover:bg-slate-800/50'}`}>
                                        <div className="pr-6">
                                            <p className="font-bold text-slate-200 truncate uppercase">{s.info.name || "Môn mới"}</p>
                                            <p className="text-[10px] text-slate-500 font-mono">{s.info.code || "---"}</p>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); if(confirm("Xóa học phần này?")) window.fb.deleteDoc(window.fb.doc(fbDbRef.current, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app', 'public', 'data', 'syllabi', s.id)); }} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 p-1"><Icons.Trash /></button>
                                    </div>
                                ))}
                            </div>
                        </nav>
                        <div className="p-4 bg-slate-800/50 border-t border-slate-800">
                            {user ? (
                                <div className="flex items-center gap-2">
                                    <img src={user.photoURL} className="w-8 h-8 rounded-full border border-blue-500" />
                                    <div className="min-w-0 flex-1"><p className="text-[10px] font-bold truncate">{user.displayName}</p><p className="text-[8px] uppercase text-emerald-400 font-bold">{userRole}</p></div>
                                    <button onClick={() => window.fb.signOut(fbAuthRef.current)} className="text-slate-500 hover:text-white"><Icons.Logout /></button>
                                </div>
                            ) : (
                                <button onClick={handleLogin} className="w-full bg-blue-600 p-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 hover:bg-blue-700 transition-all"><Icons.Google /> Đăng nhập Gmail</button>
                            )}
                        </div>
                    </aside>

                    {/* Main Area */}
                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b p-4 flex justify-between items-center shadow-sm">
                            <div className="flex flex-col">
                                <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2 uppercase tracking-tight">
                                    {syllabus.info.name || "Soạn thảo đề cương"}
                                    {syllabus.info.code && <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 font-mono uppercase">{syllabus.info.code}</span>}
                                </h2>
                                {syllabus.ownerEmail && (
                                    <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-1">
                                        <Icons.User />
                                        <span>Người sở hữu: <span className="font-medium text-slate-500">{syllabus.ownerEmail}</span></span>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setSyllabus(initialSyllabus)} className="flex items-center gap-2 bg-amber-400 text-amber-900 px-4 py-2 rounded-xl text-xs font-bold hover:bg-amber-500 shadow-lg shadow-amber-100 transition-all">
                                    <Icons.Plus /> Tạo mới
                                </button>
                                <button onClick={handleDuplicate} disabled={!isAdmin && !isEditor} className="flex items-center gap-2 bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-200 disabled:opacity-50 transition-all"><Icons.Copy /> Nhân bản</button>
                                <button onClick={saveToCloud} disabled={isSaving || !canEditThis} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 disabled:opacity-50 transition-all"><Icons.Save /> {isSaving ? "Đang lưu..." : "Lưu Cloud"}</button>
                                <button onClick={exportWord} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition-all"><Icons.FileText /> Xuất Word</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-10 font-times bg-white/50 animate-fade-in custom-scrollbar">
                            <div className="max-w-5xl mx-auto bg-white p-12 shadow-2xl rounded-3xl border min-h-full relative">
                                {!canEditThis && user && (
                                    <div className="absolute top-4 right-4 bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1 rounded-full text-[10px] font-bold z-10 shadow-sm animate-pulse">
                                        CHẾ ĐỘ XEM
                                    </div>
                                )}

                                {activeTab === 'info' && (
                                    <div className="space-y-8 animate-fade-in">
                                        <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tight">I. Thông tin chung</h3>
                                        
                                        <div className="grid grid-cols-2 gap-x-8 gap-y-5">
                                            <div className="space-y-1 col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tên học phần</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg font-bold outline-none bg-slate-50 focus:bg-white transition-all shadow-inner border-slate-200" value={syllabus.info.name} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, name: e.target.value}})} placeholder="Ví dụ: Công nghệ Ô tô" /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mã học phần</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg uppercase font-mono bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.code} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, code: e.target.value}})} placeholder="O7SQ01" /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Chuyên ngành</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.major} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, major: e.target.value}})} placeholder="Kỹ thuật Xe máy quân sự" /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Loại học phần</label><select disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white shadow-inner border-slate-200 outline-none" value={syllabus.info.type} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, type: e.target.value}})}><option>Bắt buộc</option><option>Tự chọn</option></select></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Học phần trước</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.prerequisites} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, prerequisites: e.target.value}})} placeholder="Nhập học phần..." /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Học phần song hành</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.parallel} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, parallel: e.target.value}})} placeholder="Nhập học phần..." /></div>
                                            <div className="space-y-1 col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Bộ môn / Khoa phụ trách</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.contact} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, contact: e.target.value}})} /></div>
                                        </div>

                                        <div className="bg-blue-50/80 p-8 rounded-[2rem] space-y-8 shadow-inner border border-blue-100 mt-6 animate-fade-in">
                                            <h4 className="text-xs font-bold text-blue-800 uppercase italic tracking-wider flex items-center gap-2">
                                                <Icons.CLO /> Phân bổ tín chỉ và thời lượng tiết học
                                            </h4>
                                            
                                            <div className="grid grid-cols-3 gap-8">
                                                <CreditStepper label="Tín chỉ Lý thuyết" field="theory" value={syllabus.info.credits.theory} />
                                                <CreditStepper label="Tín chỉ Thực hành" field="practice" value={syllabus.info.credits.practice} />
                                                <CreditStepper label="Tín chỉ Thực tập" field="internship" value={syllabus.info.credits.internship} />
                                            </div>

                                            <div className="grid grid-cols-4 gap-4 pt-6 border-t border-blue-200">
                                                <div className="text-center bg-blue-600 text-white rounded-2xl p-4 shadow-lg">
                                                    <p className="text-[10px] font-bold uppercase opacity-80 mb-1">Số tín chỉ</p>
                                                    <p className="text-3xl font-bold">{syllabus.info.credits.total}</p>
                                                </div>
                                                <div className="text-center bg-white rounded-2xl p-4 shadow-sm border border-blue-100 flex flex-col justify-center">
                                                    <p className="text-[10px] font-bold text-blue-400 uppercase mb-1">Tiết Lý thuyết</p>
                                                    <p className="text-xl font-bold text-slate-700">{syllabus.info.hours.theory}</p>
                                                </div>
                                                <div className="text-center bg-white rounded-2xl p-4 shadow-sm border border-blue-100 flex flex-col justify-center">
                                                    <p className="text-[10px] font-bold text-blue-400 uppercase mb-1">Tiết TH / TT / TL</p>
                                                    <p className="text-xl font-bold text-slate-700">{syllabus.info.hours.practice}</p>
                                                </div>
                                                <div className="text-center bg-white rounded-2xl p-4 shadow-sm border border-blue-100 flex flex-col justify-center">
                                                    <p className="text-[10px] font-bold text-emerald-500 uppercase mb-1">Số tiết tự học</p>
                                                    <p className="text-xl font-bold text-emerald-700">{syllabus.info.hours.selfStudy}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'objectives' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">II. Mục tiêu học phần</h3>
                                        <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl focus:ring-1 focus:ring-blue-400 outline-none text-sm leading-relaxed shadow-inner italic bg-slate-50 font-times" value={syllabus.objectives} onChange={e => setSyllabus({...syllabus, objectives: e.target.value})} placeholder="Nêu rõ mục tiêu cần đạt được đối với người học sau khi học xong học phần về kiến thức, kỹ năng, mức tự chủ trách nhiệm. Thể hiện sự tương quan với các chuẩn đầu ra của chương trình đào tạo" />
                                    </div>
                                )}

                                {activeTab === 'clos' && (
                                    <div className="space-y-10 animate-fade-in">
                                        <section>
                                            <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 mb-4 tracking-tighter">III. Chuẩn đầu ra</h3>
                                            <div className="space-y-2">
                                                {syllabus.clos.map((c, idx) => (
                                                    <div key={idx} className="flex gap-2 group animate-fade-in">
                                                        <input disabled={!canEditThis} className="w-16 p-2 border rounded font-bold text-center uppercase shadow-sm bg-slate-50" value={c.id} onChange={e => { const n = [...syllabus.clos]; n[idx].id = e.target.value; setSyllabus({...syllabus, clos: n}) }} />
                                                        <textarea disabled={!canEditThis} className="flex-1 p-2 border rounded shadow-sm focus:ring-1 focus:ring-blue-400 outline-none font-times" rows="1" value={c.content} onChange={e => { const n = [...syllabus.clos]; n[idx].content = e.target.value; setSyllabus({...syllabus, clos: n}) }} />
                                                        {canEditThis && <button onClick={() => setSyllabus({...syllabus, clos: syllabus.clos.filter((_, i) => i !== idx)})} className="text-slate-300 hover:text-red-500 p-1 transition-colors"><Icons.Trash /></button>}
                                                    </div>
                                                ))}
                                                <button disabled={!canEditThis} onClick={() => setSyllabus({...syllabus, clos: [...syllabus.clos, {id: `HP${syllabus.clos.length+1}`, content: ''}]})} className="text-blue-600 text-xs font-bold hover:underline py-2">+ Thêm chuẩn đầu ra</button>
                                            </div>
                                        </section>
                                        <section className="pt-6 border-t border-slate-100">
                                            <div className="flex justify-between items-center mb-4">
                                                <h4 className="text-sm font-bold text-slate-600 italic tracking-tighter">Bảng đóng góp của chuẩn đầu ra học phần đối với chuẩn đầu ra CTĐT:</h4>
                                                {canEditThis && (
                                                    <button onClick={() => {
                                                        const newPLO = `PLO ${syllabus.cloMatrix.plos.length + 1}`;
                                                        setSyllabus(prev => ({...prev, cloMatrix: {...prev.cloMatrix, plos: [...prev.cloMatrix.plos, newPLO]}}));
                                                    }} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold hover:bg-blue-100">+ Thêm cột</button>
                                                )}
                                            </div>
                                            <div className="overflow-x-auto border rounded-xl shadow-sm bg-white">
                                                <table className="w-full text-xs text-left border-collapse">
                                                    <thead className="bg-slate-50 border-b">
                                                        <tr>
                                                            <th className="p-4 border-r min-w-[120px] font-bold uppercase text-slate-500 text-center">Chuẩn đầu ra học phần</th>
                                                            {syllabus.cloMatrix.plos.map((p, idx) => (
                                                                <th key={idx} className="p-2 text-center border-r text-blue-600 font-bold min-w-[60px] relative group">
                                                                    <input disabled={!canEditThis} className="w-full text-center bg-transparent outline-none focus:text-blue-800 uppercase" value={p} onChange={e => {
                                                                        const n = [...syllabus.cloMatrix.plos];
                                                                        n[idx] = e.target.value;
                                                                        setSyllabus({...syllabus, cloMatrix: {...syllabus.cloMatrix, plos: n}});
                                                                    }} />
                                                                    {canEditThis && (
                                                                        <button onClick={() => {
                                                                            const n = syllabus.cloMatrix.plos.filter((_, i) => i !== idx);
                                                                            setSyllabus({...syllabus, cloMatrix: {...syllabus.cloMatrix, plos: n}});
                                                                        }} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 items-center justify-center hidden group-hover:flex">×</button>
                                                                    )}
                                                                </th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {syllabus.clos.map((c, cIdx) => (
                                                            <tr key={cIdx} className="border-b last:border-none hover:bg-slate-50/50 transition-colors">
                                                                <td className="p-4 border-r font-bold bg-slate-50/30 text-slate-700 text-center">{c.id}</td>
                                                                {syllabus.cloMatrix.plos.map((p, pIdx) => (
                                                                    <td key={pIdx} className="p-0 border-r last:border-none">
                                                                        <input disabled={!canEditThis} className="w-full text-center p-3 uppercase bg-transparent outline-none focus:bg-blue-50/50" placeholder="-" value={syllabus.cloMatrix.mapping[c.id]?.[p] || ''} onChange={e => {
                                                                            const val = e.target.value;
                                                                            setSyllabus(prev => ({...prev, cloMatrix: {...prev.cloMatrix, mapping: {...prev.cloMatrix.mapping, [c.id]: {...prev.cloMatrix.mapping[c.id], [p]: val}}}}));
                                                                        }} />
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                        <tr className="bg-blue-50/30 font-bold border-t border-blue-200">
                                                            <td className="p-4 border-r text-blue-800 text-center italic">Học phần: {syllabus.info.name || "..."}</td>
                                                            {syllabus.cloMatrix.plos.map((p, idx) => {
                                                                const summaryValue = calculatePloSummary(p);
                                                                return (
                                                                    <td key={idx} className="p-3 text-center border-r text-blue-700 font-bold text-sm bg-blue-50/20">
                                                                        {summaryValue || ""}
                                                                    </td>
                                                                );
                                                            })}
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <p className="text-[14px] leading-relaxed italic text-amber-700">
                                                * Chỉ liệt kê các CĐRCTĐT/CB thực sự hỗ trợ, đóng góp..<br/>
                                                Mức I (Introduced): Học phần hỗ trợ đạt được CĐR CTĐT ở mức băt đầu.<br/>
Mức R (Reinforced): Học phần hỗ trợ đạt được CĐR CTĐT ở nâng cao hơn  mức bắt đầu.<br/>
Mức M (Mastery): Học phần hỗ trợ mạnh mẽ (mức cao) người học đạt được CĐR CTĐT ở. <br/>
Học phần A (Assessment): Học phần cốt lõi (hỗ trợ tối đa việc đạt được các CĐR CTĐT ở. Đây là học phần cần thu thập dữ liệu để đo lường đánh giá mức độ đạt được của người học.
<br/>
                                                ** Hàng cuối cùng: tổng hợp mức đóng góp cao nhất tương ứng với từng cột CĐRCTĐT/CB (Tự động)
                                            </p>
                                        </section>
                                    </div>
                                )}

                                {activeTab === 'description' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">IV. Mô tả học phần</h3>
                                        <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl focus:ring-1 focus:ring-blue-400 outline-none text-sm leading-relaxed shadow-inner italic bg-slate-50 font-times" value={syllabus.description} onChange={e => setSyllabus({...syllabus, description: e.target.value})} placeholder="Tóm tắt nội dung chính..." />
                                    </div>
                                )}

                                {activeTab === 'structure' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="flex justify-between items-center">
                                            <h3 className="text-lg font-bold uppercase text-slate-800 tracking-tighter">V. Cấu trúc học phần</h3>
                                            <button disabled={!canEditThis} onClick={() => setSyllabus({...syllabus, structure: [...syllabus.structure, { level: 0, title: '', clo: 'HP1', isTest: false, lt: 0, tl: 0, thn: 0, thd: 0, bt: 0, kt: 0, extra: 0, material: [] }]})} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">+ Thêm hàng mới</button>
                                        </div>

                                        <div className="overflow-visible border rounded-xl shadow-lg bg-white">
                                            <table className="w-full text-[13px] text-left border-collapse font-times">
                                                <thead className="bg-slate-50 font-bold border-b text-slate-600 sticky top-0 z-20">
                                                    <tr>
                                                        <th className="p-2 border-r w-10 text-center" rowSpan="2">Mức</th>
                                                        <th className="p-2 border-r w-12 text-center" rowSpan="2">STT</th>
                                                        <th className="p-2 border-r min-w-[150px]" rowSpan="2">Nội dung</th>
                                                        <th className="p-2 border-r w-16 text-center" rowSpan="2">CĐR</th>
                                                        <th className="p-2 border-r w-14 text-center" rowSpan="2">Số tiết</th>
                                                        <th className="p-1 border-r text-center" colSpan="7">Phân bổ thời gian</th>
                                                        <th className="p-2 border-r w-32 text-center" rowSpan="2">Học liệu</th>
                                                        <th className="p-2 w-8" rowSpan="2"></th>
                                                    </tr>
                                                    <tr className="bg-slate-100/50">
                                                        <th className="p-1 border-r text-center w-8">LT</th>
                                                        <th className="p-1 border-r text-center w-8">TL</th>
                                                        <th className="p-1 border-r text-center w-8">THN</th>
                                                        <th className="p-1 border-r text-center w-8">THĐ</th>
                                                        <th className="p-1 border-r text-center w-10">BT(TN)</th>
                                                        <th className="p-1 border-r text-center w-10">KT,thi</th>
                                                        <th className="p-1 border-r text-center w-8">...</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {syllabus.structure.map((item, idx) => {
                                                        const isParent = hasChildren(idx);
                                                        const isLesson = item.level === 0;
                                                        const isSection = item.level > 0;
                                                        
                                                        return (
                                                            <tr
                                                                key={idx}
                                                                className={`group border-b hover:bg-slate-50 transition-all ${
                                                                    isLesson ? 'level-0' : item.level === 1 ? 'bg-slate-50/50' : 'italic text-slate-500'
                                                                }`}
                                                                >

                                                                <td className="p-1 border-r text-center">
                                                                    <div className="flex flex-col gap-0.5">
                                                                        <button disabled={!canEditThis} onClick={() => changeLevel(idx, -1)} className="hover:text-blue-600 transition-colors"><Icons.ArrowLeft /></button>
                                                                        <button disabled={!canEditThis} onClick={() => changeLevel(idx, 1)} className="hover:text-blue-600 transition-colors"><Icons.ArrowRight /></button>
                                                                    </div>
                                                                </td>
                                                                <td className="p-1 border-r text-center">
                                                                    <input disabled={!canEditThis} className="table-input font-bold" value={item.isTest ? "*" : getAutoSTT(idx)} onChange={e => {
                                                                        const val = e.target.value.trim();
                                                                        updateStructureField(idx, 'isTest', val === '*');
                                                                    }} />
                                                                </td>
                                                                <td className="p-1 border-r">
                                                                    <div className={`${item.level === 1 ? 'pl-4' : item.level === 2 ? 'pl-8' : ''}`}>
                                                                        <input disabled={!canEditThis} className="w-full outline-none bg-transparent font-medium" value={item.title} onChange={e => updateStructureField(idx, 'title', e.target.value)} />
                                                                    </div>
                                                                </td>
                                                                <td className="p-1 border-r">
                                                                    {(!isSection || item.isTest) ? (
                                                                        <input disabled={!canEditThis} className="table-input font-bold text-blue-600 uppercase" value={item.clo} onChange={e => updateStructureField(idx, 'clo', e.target.value)} />
                                                                    ) : (
                                                                        <div className="text-center text-slate-300">-</div>
                                                                    )}
                                                                </td>
                                                                <td className="p-1 border-r text-center font-bold text-emerald-700 bg-emerald-50/30">
                                                                    {calculateRowTotal(idx)}
                                                                </td>
                                                                {['lt', 'tl', 'thn', 'thd', 'bt', 'kt', 'extra'].map(field => (
                                                                    <td key={field} className="p-1 border-r">
                                                                        <input 
                                                                            type="number" 
                                                                            // Thêm step="0.1" hoặc "any" để cho phép số thập phân
                                                                            step="0.5" 
                                                                            disabled={!canEditThis || isParent} 
                                                                            className="table-input" 
                                                                            // Hiển thị giá trị (giữ nguyên nếu là số)
                                                                            value={getAggregatedValue(idx, field) || ''} 
                                                                            onChange={e => {
                                                                                // Thay parseInt bằng parseFloat để giữ lại phần thập phân
                                                                                // Thay dấu phẩy thành dấu chấm nếu người dùng nhập kiểu Việt Nam
                                                                                const val = e.target.value.replace(',', '.');
                                                                                updateStructureField(idx, field, parseFloat(val) || 0);
                                                                            }} 
                                                                        />
                                                                    </td>
                                                                ))}
                                                                <td className="p-1 border-r relative group/m">
                                                                    {isLesson && !item.isTest ? (
                                                                        <div className="relative">
                                                                            <div className="flex flex-wrap gap-0.5 min-h-[24px] p-1 rounded border border-transparent hover:border-blue-200 cursor-pointer bg-slate-50/50">
                                                                                {item.material?.length > 0 ? (
                                                                                    item.material.map(m => (
                                                                                        <span key={m} className="bg-blue-600 text-white px-1 rounded text-[10px] font-bold">{m}</span>
                                                                                    ))
                                                                                ) : <span className="text-slate-400 italic text-[11px]">Chọn...</span>}
                                                                            </div>
                                                                            <div className="hidden group-hover/m:grid absolute right-0 bottom-full bg-white border border-slate-200 shadow-2xl rounded-xl p-2 z-50 w-56 mb-1 grid-cols-4 gap-1 animate-fade-in">
                                                                                <p className="col-span-4 text-[9px] font-bold text-slate-400 uppercase mb-1 px-1">Tích chọn học liệu:</p>
                                                                                {getAvailableMaterials().map(m => (
                                                                                    <button key={m} onClick={() => {
                                                                                        const cur = item.material || [];
                                                                                        updateStructureField(idx, 'material', cur.includes(m) ? cur.filter(x => x !== m) : [...cur, m].sort((a,b) => parseInt(a.match(/\d+/)) - parseInt(b.match(/\d+/))));
                                                                                    }} className={`px-1 py-1 rounded text-[11px] font-bold border transition-all ${item.material?.includes(m) ? 'bg-blue-600 text-white border-blue-600' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-blue-50'}`}>{m}</button>
                                                                                ))}
                                                                                {getAvailableMaterials().length === 0 && <p className="col-span-4 text-[10px] italic text-red-400 p-2">Vui lòng nhập danh mục tài liệu ở Mục VIII trước.</p>}
                                                                            </div>
                                                                        </div>
                                                                    ) : <span className="text-slate-300 block text-center">-</span>}
                                                                </td>
                                                                <td className="p-1 text-center relative">
                                                                <div className="flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-all">

                                                                    {/* ➕ Thêm dòng */}
                                                                    {canEditThis && (
                                                                    <button
                                                                        onClick={() => insertRowAfter(idx)}
                                                                        className="text-green-500 hover:text-green-700"
                                                                        title="Thêm dòng phía dưới"
                                                                    >
                                                                        <Icons.Plus />
                                                                    </button>
                                                                    )}

                                                                    {/* 🗑️ Xóa dòng */}
                                                                    {canEditThis && (
                                                                    <button
                                                                        onClick={() =>
                                                                        setSyllabus({
                                                                            ...syllabus,
                                                                            structure: syllabus.structure.filter((_, i) => i !== idx)
                                                                        })
                                                                        }
                                                                        className="text-slate-300 hover:text-red-500"
                                                                        title="Xóa dòng"
                                                                    >
                                                                        <Icons.Trash />
                                                                    </button>
                                                                    )}
                                                                </div>
                                                                </td>

                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                                <tfoot className="sticky-footer text-[11px] uppercase">
                                                    <tr className="bg-slate-100/80">
                                                        <td colSpan="4" className="p-3 text-right border-r font-black text-slate-700">CỘNG:</td>
                                                        <td className="p-3 text-center border-r text-emerald-800 font-black text-base">{calculateGrandTotal('total')}</td>
                                                        {['lt','tl','thn','thd','bt','kt','extra'].map(f => <td key={f} className="p-3 text-center border-r font-black text-slate-800">{calculateGrandTotal(f)}</td>)}
                                                        <td colSpan="2" className="p-3"></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <p className="text-[14px] leading-relaxed italic text-amber-700">
                                            * Lưu ý: Các ô Số tiết của Bài/Mục sẽ tự động cộng dồn từ cấp con bên dưới. Chỉ nhập trực tiếp vào hàng không có phân cấp nhỏ hơn.<br/>
                                            ** Chuẩn đầu ra (CĐR); Lý thuyết (LT); Thực hành (TH), ngày (N), đêm (Đ); Thảo luận (TL); Bài tập, thí nghiệm (BT, TN); Kiểm tra (KT); Hướng dẫn (HD).
                                        </p>
                                    </div>
                                )}

                               {activeTab === 'teaching' && (
  <div className="space-y-6 animate-fade-in">
    <h3 className="text-lg font-bold uppercase text-slate-800 tracking-tighter">
      VI. KẾ HOẠCH VÀ PHƯƠNG PHÁP DẠY HỌC
    </h3>

    <div className="overflow-x-auto border rounded-xl shadow-lg bg-white">
    <table className="w-full text-[15px] text-left border-collapse font-times">

        {/* === CHUẨN THEO FILE WORD === */}
        <colgroup>
          <col style={{ width: "9%" }} />
          <col style={{ width: "26%" }} />
          <col style={{ width: "8%" }} />
          <col style={{ width: "25%" }} />
          <col style={{ width: "25%" }} />
          <col style={{ width: "8%" }} />
        </colgroup>



        <thead className="bg-slate-50 font-bold border-b text-slate-600">
          <tr>
            <th className="p-3 border-r text-center">Bài học<br />(Số tiết)</th>
            <th className="p-3 border-r">Nội dung</th>
            <th className="p-3 border-r text-center">CĐR</th>
            <th className="p-3 border-r">Giảng viên</th>
            <th className="p-3 border-r">Học viên</th>
            <th className="p-3 text-center">KT, thi</th>
          </tr>
        </thead>

        <tbody>
          {syllabus.structure.map((item, idx) => {
            // Chỉ render BÀI (level 0), bỏ test
            if (item.level !== 0 || item.isTest) return null;

            const lessonKey = getAutoSTT(idx);
            const plan = syllabus.teachingPlan?.[lessonKey] || {};

            // Gom tiểu mục 1.1, 1.2, 1.3...
            const subItems = getLessonSubItems(syllabus.structure, idx);

            return (
              <tr
                key={`plan-${lessonKey}`}
                className="border-b hover:bg-slate-50 transition-all align-top"
              >
                {/* CỘT 1: BÀI */}
                <td className="p-2 border-r text-center font-bold text-blue-900 bg-slate-50/30 whitespace-nowrap">
                  Bài {lessonKey}
                  <div className="text-xs font-normal text-slate-500">
                    ({calculateRowTotal(idx)} tiết)
                  </div>
                </td>

                {/* CỘT 2: NỘI DUNG */}
                <td className="p-2 border-r text-slate-700 break-words">
                  <div className="font-semibold">
                    {lessonKey}. {item.title}
                  </div>

                  {subItems.length > 0 && (
                    <ul className="mt-1 ml-4 list-disc text-[12px] space-y-0.5">
                      {subItems.map((sub, i) => (
                        <li key={i} className="italic">
                          {sub}
                        </li>
                      ))}
                    </ul>
                  )}
                </td>

                {/* CỘT 3: CĐR */}
                <td className="p-2 border-r text-center font-mono whitespace-nowrap">
                  {item.clo}
                </td>

                {/* CỘT 4: GIẢNG VIÊN */}
                <td className="p-2 border-r">
                  <textarea
                    rows="3"
                    className="w-full resize-none bg-transparent outline-none border border-dashed border-slate-300 p-1 focus:bg-white rounded"
                    value={plan.instructor || ''}
                    onChange={e =>
                      updateTeachingPlanField(lessonKey, 'instructor', e.target.value)
                    }
                    placeholder="Hình thức, phương pháp giảng dạy..."
                  />
                </td>

                {/* CỘT 5: HỌC VIÊN */}
                <td className="p-2 border-r">
                  <textarea
                    rows="3"
                    className="w-full resize-none bg-transparent outline-none border border-dashed border-slate-300 p-1 focus:bg-white rounded"
                    value={plan.student || ''}
                    onChange={e =>
                      updateTeachingPlanField(lessonKey, 'student', e.target.value)
                    }
                    placeholder="Yêu cầu, hoạt động học tập..."
                  />
                </td>

                {/* CỘT 6: KIỂM TRA */}
                <td className="p-2 text-center whitespace-nowrap">
                  <input
                    className="w-full bg-transparent outline-none border border-dashed border-slate-300 p-1 text-center font-bold text-red-600 focus:bg-white rounded"
                    value={plan.exam || ''}
                    onChange={e =>
                      updateTeachingPlanField(lessonKey, 'exam', e.target.value)
                    }
                    placeholder="A1.1"
                  />
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>

    <p className="text-[14px] leading-relaxed italic text-amber-700">
      * Dữ liệu các cột 1, 2, 3 được đồng bộ tự động từ Mục 5. Cấu trúc học phần.
    </p>
  </div>
)}


                                {activeTab === 'assessment' && (
    <div className="space-y-6 animate-fade-in font-times">

        <h3 className="text-xl font-bold uppercase text-slate-800">
            VII. ĐÁNH GIÁ KẾT QUẢ HỌC TẬP
        </h3>

        <div className="overflow-x-auto border rounded-xl shadow-lg bg-white">
            <table className="w-full text-[14px] border-collapse">
                <thead className="bg-slate-100 font-bold text-slate-700">
                    <tr>
                        <th className="p-3 border text-center w-[15%]">Hình thức đánh giá</th>
                        <th className="p-3 border text-center w-[8%]">Mã</th>
                        <th className="p-3 border text-center w-[15%]">Thời điểm</th>
                        <th className="p-3 border text-center w-[22%]">Phương pháp</th>
                        <th className="p-3 border text-center w-[22%]">Tiêu chí</th>
                        <th className="p-3 border text-center w-[10%]">Đáp ứng CĐR</th>
                        <th className="p-3 border text-center w-[8%]">Tỉ lệ (%)</th>
                        <th className="p-1 border w-12"></th>
                    </tr>
                </thead>

                <tbody>
                    {(syllabus.assessments || []).map((row, index) => (
                        <tr
                            key={index}
                            className="group hover:bg-blue-50/30 align-top transition-colors"
                        >
                            {/* 1. Hình thức */}
                            <td className="p-2 border">
                                <textarea
                                    className="w-full bg-transparent outline-none focus:ring-1 ring-blue-200 p-1 rounded resize-none min-h-[60px]"
                                    value={row.form}
                                    onChange={e => updateAssessmentRow(index, 'form', e.target.value)}
                                    placeholder="Ví dụ: Đánh giá thường xuyên 1"
                                />
                            </td>

                            {/* 2. Mã */}
                            <td className="p-2 border bg-slate-50/50">
                                <input
                                    className="w-full bg-transparent outline-none text-center font-mono font-bold text-blue-700"
                                    value={row.examCode}
                                    onChange={e => updateAssessmentRow(index, 'examCode', e.target.value)}
                                    placeholder="A1.1"
                                />
                            </td>

                            {/* 3. Thời điểm */}
                            <td className="p-2 border">
                                <textarea
                                    className="w-full bg-transparent outline-none focus:ring-1 ring-blue-200 p-1 rounded resize-none min-h-[60px]"
                                    value={row.time}
                                    onChange={e => updateAssessmentRow(index, 'time', e.target.value)}
                                />
                            </td>

                            {/* 4. Phương pháp */}
                            <td className="p-2 border">
                                <textarea
                                    className="w-full bg-transparent outline-none focus:ring-1 ring-blue-200 p-1 rounded resize-none min-h-[60px] text-[13px]"
                                    value={row.method}
                                    onChange={e => updateAssessmentRow(index, 'method', e.target.value)}
                                />
                            </td>

                            {/* 5. Tiêu chí */}
                            <td className="p-2 border">
                                <textarea
                                    className="w-full bg-transparent outline-none focus:ring-1 ring-blue-200 p-1 rounded resize-none min-h-[60px] text-[12px] leading-tight"
                                    value={row.criteria}
                                    onChange={e => updateAssessmentRow(index, 'criteria', e.target.value)}
                                />
                            </td>

                            {/* 6. CĐR */}
                            <td className="p-2 border text-center">
                                <input
                                    className="w-full bg-transparent outline-none text-center font-bold text-indigo-700"
                                    value={row.clo}
                                    onChange={e => updateAssessmentRow(index, 'clo', e.target.value)}
                                    placeholder="HP1, HP2"
                                />
                            </td>

                            {/* 7. Tỉ lệ */}
                            <td className="p-2 border">
                            <input
                                type="number"
                                min="0"
                                max="100"
                                step="10"
                                className="w-full bg-transparent outline-none text-center font-bold text-emerald-700 appearance-none"
                                value={row.weight ?? ''}
                                onChange={e =>
                                    updateAssessmentRow(
                                        index,
                                        'weight',
                                        e.target.value === '' ? '' : Number(e.target.value)
                                    )
                                }
                                placeholder="10"
                            />

                            </td>

                            {/* ➕ / 🗑️ */}
                            <td className="p-1 border text-center align-middle">
                                <div className="flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                    {canEditThis && (
                                        <button
                                            onClick={() => insertAssessmentRowAfter(index)}
                                            className="text-green-500 hover:text-green-700"
                                            title="Thêm dòng phía dưới"
                                        >
                                            <Icons.Plus />
                                        </button>
                                    )}

                                    {canEditThis && (
                                        <button
                                            onClick={() => removeAssessmentRow(index)}
                                            className="text-slate-300 hover:text-red-500"
                                            title="Xóa dòng"
                                        >
                                            <Icons.Trash />
                                        </button>
                                    )}
                                </div>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>

        {/* Tổng tỉ lệ */}
        <div className="flex justify-end pr-4">
            {(() => {
                const total = (syllabus.assessments || [])
                    .reduce((sum, r) => sum + (parseFloat(r.weight) || 0), 0);

                return (
                    <div className={`flex items-center gap-2 p-3 rounded-lg border-2
                        ${total === 100
                            ? 'bg-emerald-50 border-emerald-200 text-emerald-700'
                            : 'bg-red-50 border-red-200 text-red-700'}`}
                    >
                        <span className="font-bold">Tổng tỉ lệ:</span>
                        <span className="text-xl font-black">{total}%</span>
                        {total !== 100 && (
                            <span className="text-xs italic">(Cần đạt 100%)</span>
                        )}
                    </div>
                );
            })()}
        </div>
    </div>
)}

                                {activeTab === 'materials' && (
                                    <div className="space-y-10 animate-fade-in">
                                        <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">VIII. Cơ sở vật chất, học liệu</h3>
                                        <section className="space-y-4">
                                            <div className="flex justify-between items-center"><h4 className="text-sm font-bold text-slate-700 uppercase">1. Học liệu bắt buộc</h4>{canEditThis && <button onClick={() => setSyllabus({...syllabus, materials: {...syllabus.materials, required: [...syllabus.materials.required, '']}})} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold hover:bg-blue-100 transition-all">+ Thêm tài liệu</button>}</div>
                                            <div className="space-y-2">
                                                {(syllabus.materials?.required || []).map((mat, idx) => (
                                                    <div key={idx} className="flex gap-2 items-start animate-fade-in"><span className="w-10 pt-2 text-center font-bold text-slate-400">[{idx + 1}]</span><textarea disabled={!canEditThis} className="flex-1 p-2 border rounded-xl bg-slate-50 focus:bg-white outline-none font-times text-sm transition-all" rows="1" value={mat} onChange={e => { const n=[...syllabus.materials.required]; n[idx]=e.target.value; setSyllabus({...syllabus, materials: {...syllabus.materials, required: n}})}} />{canEditThis && syllabus.materials.required.length > 1 && <button onClick={() => setSyllabus({...syllabus, materials: {...syllabus.materials, required: syllabus.materials.required.filter((_, i) => i !== idx)}})} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash /></button>}</div>
                                                ))}
                                            </div>
                                        </section>
                                        <section className="space-y-4">
                                            <div className="flex justify-between items-center"><h4 className="text-sm font-bold text-slate-700 uppercase">2. Học liệu tham khảo</h4>{canEditThis && <button onClick={() => setSyllabus({...syllabus, materials: {...syllabus.materials, reference: [...syllabus.materials.reference, '']}})} className="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold hover:bg-blue-100 transition-all">+ Thêm tài liệu</button>}</div>
                                            <div className="space-y-2">
                                                {(syllabus.materials?.reference || []).map((mat, idx) => (
                                                    <div key={idx} className="flex gap-2 items-start animate-fade-in"><span className="w-10 pt-2 text-center font-bold text-slate-400">[{syllabus.materials.required.length + idx + 1}]</span><textarea disabled={!canEditThis} className="flex-1 p-2 border rounded-xl bg-slate-50 focus:bg-white outline-none font-times text-sm transition-all" rows="1" value={mat} onChange={e => { const n=[...syllabus.materials.reference]; n[idx]=e.target.value; setSyllabus({...syllabus, materials: {...syllabus.materials, reference: n}})}} />{canEditThis && syllabus.materials.reference.length > 0 && <button onClick={() => setSyllabus({...syllabus, materials: {...syllabus.materials, reference: syllabus.materials.reference.filter((_, i) => i !== idx)}})} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash /></button>}</div>
                                                ))}
                                            </div>
                                        </section>
                                        <section className="space-y-4">
                                            <h4 className="text-sm font-bold text-slate-700 uppercase">3. Cơ sở vật chất phục vụ dạy học</h4>
                                            <textarea disabled={!canEditThis} rows="6" className="w-full p-6 border rounded-2xl outline-none text-sm shadow-inner italic bg-slate-50 font-times focus:ring-1 focus:ring-blue-400" value={syllabus.materials?.equipment} onChange={e => setSyllabus({...syllabus, materials: {...syllabus.materials, equipment: e.target.value}})} placeholder="Các trang thiết bị chuyên dụng, phòng thí nghiệm..." />
                                        </section>
                                            <p className="text-[14px] leading-relaxed italic text-amber-700">
                                            * Các giáo trình, tài liệu tham khảo, các phần mềm, giáo trình điện tử.
                                            Liệt kê không quá 6 tài liệu.
                                            </p>


                                    </div>
                                )}

                                {activeTab === 'regulations' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">IX. Quy định của học phần</h3>
                                        <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl focus:ring-1 focus:ring-blue-400 outline-none text-sm leading-relaxed shadow-inner italic bg-slate-50 font-times" value={syllabus.regulations} onChange={e => setSyllabus({...syllabus, regulations: e.target.value})} placeholder="Các quy định về thi cử, thái độ học tập..." />
                                    </div>
                                )}

                                <div className="mt-10 text-[10px] text-slate-400 italic text-center border-t border-slate-100 pt-6 uppercase tracking-[0.2em]">CTĐT - SQKT 2026</div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
