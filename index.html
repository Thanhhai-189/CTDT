<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyllabusPro V4.0 - Restore & Preview</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Thư viện xử lý Word -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getApps, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .font-times { font-family: "Times New Roman", Times, serif; }
        
        /* Cấu hình trang xem trước (Document Mode) */
        .preview-mode {
            font-family: "Times New Roman", Times, serif !important;
            font-size: 18.6px !important; /* Xấp xỉ font 14pt */
            line-height: 1.3 !important;
            text-align: justify;
        }
        .preview-mode input, .preview-mode textarea {
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
            width: 100%;
            display: block;
            font-family: inherit !important;
            font-size: inherit !important;
            box-shadow: none !important;
            height: auto !important;
            resize: none;
            outline: none;
        }
        .preview-mode .indent-line {
            padding-left: 1cm;
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            CLO: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Description: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Assessment: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
            Materials: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/><path d="M4 20h16"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBen_GxaeXrll6FSRiegH-Lh1ZXY_a9jrM",
            authDomain: "ctdt-sqkt.firebaseapp.com",
            projectId: "ctdt-sqkt",
            storageBucket: "ctdt-sqkt.firebasestorage.app",
            messagingSenderId: "491495146400",
            appId: "1:491495146400:web:519534d3535d8a8d615ac5",
            measurementId: "G-NDJJCTXVN3"
        };

        const initialSyllabus = {
            id: '', ownerUid: '', ownerEmail: '',
            header: { schoolName: 'TRƯỜNG SĨ QUAN KTQS', department: 'KHOA Ô TÔ', city: 'Thành phố Hồ Chí Minh', date: '2025' },
            info: { 
                name: '', code: '', major: '', type: 'Bắt buộc', prerequisites: '', parallel: '', contact: 'Khoa Ô tô',
                credits: { theory: 0, practice: 0, internship: 0, total: 0 }, 
                hours: { classroom: 0, theory: 0, practice: 0, internship: 0, exam: 2, selfStudy: 0 } 
            },
            objectives: '', description: '',
            clos: [{ id: 'HP1', content: '' }],
            cloMatrix: { plos: ['KT 1', 'KT 2', 'KN 1', 'KN 2'], mapping: {} },
            structure: [],
            teachingPlan: [],
            assessments: [{ code: 'A1.1', type: 'Thường xuyên', method: 'Vấn đáp', criteria: 'Chuyên cần, kiến thức', weight: '10%', clo: 'HP1' }],
            materials: '', 
            regulations: ''
        };

        function App() {
            const [syllabus, setSyllabus] = useState(initialSyllabus);
            const [savedSyllabi, setSavedSyllabi] = useState([]);
            const [activeTab, setActiveTab] = useState('info');
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('checking...'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [isPreviewMode, setIsPreviewMode] = useState(false);
            
            const fbAppRef = useRef(null);
            const fbDbRef = useRef(null);
            const fbAuthRef = useRef(null);

            const fetchUserRole = async (u) => {
                if (!u) return;
                const { doc, getDoc } = window.fb;
                try {
                    const userDoc = await getDoc(doc(fbDbRef.current, 'users', u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const role = data.role || data.Role || 'guest';
                        setUserRole(role.toString().toLowerCase());
                    } else setUserRole('guest');
                } catch (e) { setUserRole('guest'); }
            };

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const { initializeApp, getApps, getAuth, onAuthStateChanged, getFirestore } = window.fb;
                        if (!fbAppRef.current) {
                            fbAppRef.current = getApps().length > 0 ? getApps()[0] : initializeApp(FIREBASE_CONFIG);
                            fbDbRef.current = getFirestore(fbAppRef.current);
                            fbAuthRef.current = getAuth(fbAppRef.current);
                        }
                        onAuthStateChanged(fbAuthRef.current, async (u) => {
                            setUser(u);
                            if (u) await fetchUserRole(u);
                            else setUserRole('guest');
                            setLoading(false);
                        });
                    } catch (e) { setLoading(false); }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !fbDbRef.current) return;
                const { collection, onSnapshot } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const q = collection(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSavedSyllabi(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [user]);

            const handleLogin = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.fb;
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(fbAuthRef.current, provider); } catch (e) { alert(e.message); }
            };

            const isAdmin = userRole === 'admin';
            const isEditor = userRole === 'editor';
            const isOwner = syllabus.ownerUid === user?.uid || syllabus.ownerUid === ''; 
            const canEditThis = isAdmin || (isEditor && isOwner);

            const handleCreditChange = (field, value) => {
                const val = Math.max(0, parseFloat(value) || 0);
                setSyllabus(prev => {
                    const newCredits = { ...prev.info.credits, [field]: val };
                    newCredits.total = (newCredits.theory || 0) + (newCredits.practice || 0) + (newCredits.internship || 0);
                    const hTheory = newCredits.theory * 15;
                    const hPractice = newCredits.practice * 30;
                    const hInternship = newCredits.internship * 45;
                    const newHours = { 
                        ...prev.info.hours,
                        theory: hTheory,
                        practice: hPractice + hInternship,
                        classroom: hTheory + hPractice + hInternship,
                        selfStudy: newCredits.total * 30 
                    };
                    return { ...prev, info: { ...prev.info, credits: newCredits, hours: newHours } };
                });
            };

            const saveToCloud = async () => {
                if (!user) return alert("Vui lòng đăng nhập.");
                if (!canEditThis) return alert("Không có quyền chỉnh sửa.");
                if (!syllabus.info.code) return alert("Nhập Mã học phần.");
                setIsSaving(true);
                const { doc, setDoc } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const dataToSave = { ...syllabus, ownerUid: syllabus.ownerUid || user.uid, ownerEmail: syllabus.ownerEmail || user.email };
                try {
                    await setDoc(doc(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi', syllabus.info.code), { ...dataToSave, id: syllabus.info.code, updatedAt: new Date().toISOString() });
                    alert("Đã lưu!");
                    setSyllabus(dataToSave);
                } catch (e) { alert(e.message); }
                setIsSaving(false);
            };

            const handleDuplicate = () => {
                if (!user) return alert("Vui lòng đăng nhập Gmail để nhân bản.");
                if (!isAdmin && !isEditor) return alert("Bạn không có quyền thực hiện chức năng này.");
                const duplicatedSyllabus = JSON.parse(JSON.stringify(syllabus));
                duplicatedSyllabus.id = ''; 
                duplicatedSyllabus.info.code = `${duplicatedSyllabus.info.code}-copy`;
                duplicatedSyllabus.ownerUid = user.uid;
                duplicatedSyllabus.ownerEmail = user.email;
                setSyllabus(duplicatedSyllabus);
                alert("Đã nhân bản thành công!");
            };

            const exportWord = async () => {
                const { Document, Packer, Paragraph, TextRun, AlignmentType, Table, TableRow, TableCell, WidthType, BorderStyle, VerticalAlign } = window.docx;

                const STYLES = {
                    font: "Times New Roman",
                    size: 28, // 14pt
                    alignment: AlignmentType.JUSTIFIED,
                    spacing: { before: 120, after: 120, line: 240 }, 
                    indent: { firstLine: 567 } 
                };

                const createCell = (text, options = {}) => new TableCell({
                    children: [new Paragraph({ 
                        children: [new TextRun({ text: String(text || ""), bold: options.bold, size: STYLES.size, font: STYLES.font })],
                        alignment: options.alignment || AlignmentType.CENTER
                    })],
                    verticalAlign: VerticalAlign.CENTER,
                    width: options.width
                });

                const createTextPara = (text, options = {}) => new Paragraph({
                    children: [new TextRun({ text: text || "", bold: options.bold, italic: options.italic, size: STYLES.size, font: STYLES.font })],
                    alignment: options.alignment || STYLES.alignment,
                    spacing: options.spacing || STYLES.spacing,
                    indent: options.noIndent ? undefined : (options.indent || STYLES.indent)
                });

                const sections = [];

                // Header
                sections.push(
                    new Paragraph({
                        children: [
                            new TextRun({ text: syllabus.header?.schoolName?.toUpperCase() || "TRƯỜNG SĨ QUAN KTQS", bold: true, size: 24, font: STYLES.font }),
                            new TextRun({ text: "\t\t\t\tCỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM", bold: true, size: 24, font: STYLES.font })
                        ],
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: syllabus.header?.department?.toUpperCase() || "KHOA Ô TÔ", bold: true, size: 24, font: STYLES.font }),
                            new TextRun({ text: "\t\t\t\t\tĐộc lập - Tự do - Hạnh phúc", bold: true, size: 24, font: STYLES.font })
                        ],
                    }),
                    new Paragraph({ text: "", spacing: { before: 400 } }),
                    new Paragraph({
                        children: [new TextRun({ text: "ĐỀ CƯƠNG HỌC PHẦN", bold: true, size: 32, font: STYLES.font })],
                        alignment: AlignmentType.CENTER,
                    }),
                    new Paragraph({ text: "", spacing: { before: 400 } })
                );

                // Section 1
                sections.push(
                    new Paragraph({ children: [new TextRun({ text: "I. THÔNG TIN CHUNG ĐỀ CƯƠNG HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
                    createTextPara(`Học phần: ${syllabus.info.name}`),
                    createTextPara(`Mã học phần: ${syllabus.info.code}`),
                    createTextPara(`Chuyên ngành: ${syllabus.info.major}`),
                    createTextPara(`Loại học phần: ${syllabus.info.type}`),
                    createTextPara(`Học phần trước: ${syllabus.info.prerequisites || "Không"}`),
                    createTextPara(`Học phần song hành: ${syllabus.info.parallel || "Không"}`),
                    createTextPara(`Số tín chỉ: ${syllabus.info.credits.total}`),
                    createTextPara(`Số tiết: ${syllabus.info.hours.classroom + syllabus.info.hours.exam}`),
                    createTextPara(`- Số tiết lên lớp: ${syllabus.info.hours.classroom}`, { indent: { left: 708 } }),
                    createTextPara(`+ Lý thuyết: ${syllabus.info.hours.theory}`, { indent: { left: 1134 } }),
                    createTextPara(`+ Thực hành, thí nghiệm, bài tập, thảo luận: ${syllabus.info.hours.practice}`, { indent: { left: 1134 } }),
                    createTextPara(`- Thi, kiểm tra kết thúc: ${syllabus.info.hours.exam}`, { indent: { left: 708 } }),
                    createTextPara(`- Số tiết tự học: ${syllabus.info.hours.selfStudy}`, { indent: { left: 708 } }),
                    createTextPara(`Bộ môn, khoa tham gia giảng dạy: ${syllabus.info.contact}`),
                    new Paragraph({ text: "" })
                );

                // Sections 2-4
                sections.push(
                    new Paragraph({ children: [new TextRun({ text: "II. MỤC TIÊU HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
                    createTextPara(syllabus.objectives),
                    new Paragraph({ text: "" }),
                    new Paragraph({ children: [new TextRun({ text: "III. CHUẨN ĐẦU RA (CLO)", bold: true, size: STYLES.size, font: STYLES.font })] }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [createCell("Ký hiệu", {bold:true}), createCell("Nội dung chuẩn đầu ra", {bold:true, alignment: AlignmentType.LEFT})] }),
                            ...syllabus.clos.map(c => new TableRow({ children: [createCell(c.id), createCell(c.content, {alignment: AlignmentType.LEFT})] }))
                        ]
                    }),
                    new Paragraph({ text: "", spacing: { before: 200 } }),
                    createTextPara("Ma trận đóng góp chuẩn đầu ra học phần đối với CTĐT:", {italic:true}),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [createCell("CLO"), ...syllabus.cloMatrix.plos.map(p => createCell(p, {bold:true}))] }),
                            ...syllabus.clos.map(c => new TableRow({ children: [createCell(c.id, {bold:true}), ...syllabus.cloMatrix.plos.map(p => createCell(syllabus.cloMatrix.mapping[c.id]?.[p] || "-"))] })),
                            new TableRow({ children: [createCell("Môn học", {bold:true}), ...syllabus.cloMatrix.plos.map(p => createCell(calculatePloSummary(p), {bold:true}))] })
                        ]
                    }),
                    new Paragraph({ text: "" }),
                    new Paragraph({ children: [new TextRun({ text: "IV. MÔ TẢ HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
                    createTextPara(syllabus.description),
                    new Paragraph({ text: "" })
                );

                // Section 5
                sections.push(
                    new Paragraph({ children: [new TextRun({ text: "V. CẤU TRÚC HỌC PHẦN", bold: true, size: STYLES.size, font: STYLES.font })] }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [createCell("STT"), createCell("Nội dung bài học"), createCell("CĐR"), createCell("LT"), createCell("TH"), createCell("Học liệu")] }),
                            ...syllabus.structure.map((r, i) => new TableRow({
                                children: [
                                    createCell(r.stt),
                                    createCell(r.title, { alignment: AlignmentType.LEFT }),
                                    createCell(r.clo),
                                    createCell(r.lt),
                                    createCell(r.th),
                                    createCell(r.material)
                                ]
                            }))
                        ]
                    }),
                    new Paragraph({ text: "" })
                );

                // VI-IX
                const addS = (t, c) => {
                    sections.push(new Paragraph({ children: [new TextRun({ text: t, bold: true, size: STYLES.size, font: STYLES.font })] }), createTextPara(c), new Paragraph({ text: "" }));
                };
                addS("VI. KẾ HOẠCH DẠY HỌC CHI TIẾT", syllabus.teachingPlan?.map(p => `${p.title}: GV: ${p.instructor}, HV: ${p.student}`).join("\n"));
                addS("VII. ĐÁNH GIÁ", syllabus.assessments?.map(a => `${a.code} - ${a.method}: ${a.criteria} (${a.weight})`).join("\n"));
                addS("VIII. TÀI LIỆU VÀ THIẾT BỊ", syllabus.materials);
                addS("IX. QUY ĐỊNH CỦA HỌC PHẦN", syllabus.regulations);

                // Signature
                sections.push(
                    new Paragraph({ text: "", spacing: { before: 800 } }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: BorderStyle.NONE,
                        rows: [
                            new TableRow({ children: [createCell("CHỦ NHIỆM KHOA", {bold:true}), createCell(`${syllabus.header?.city || "Tp. Hồ Chí Minh"}, ngày... tháng... năm...\nTRƯỞNG BỘ MÔN`, {bold:true})] }),
                            new TableRow({ children: [createCell("\n\n\n\n"), createCell("\n\n\n\n")] })
                        ]
                    })
                );

                const finalDoc = new Document({ sections: [{ children: sections }] });
                Packer.toBlob(finalDoc).then(blob => saveAs(blob, `De_cuong_${syllabus.info.code || 'Export'}.docx`));
            };

            const calculatePloSummary = (ploName) => {
                const levelsRank = { "": 0, "I": 1, "R": 2, "M": 3 };
                let maxLevelNum = 0;
                let hasAssessment = false;
                syllabus.clos.forEach(clo => {
                    const v = (syllabus.cloMatrix.mapping[clo.id]?.[ploName] || "").toUpperCase().trim();
                    if (!v) return;
                    if (v.includes("A")) hasAssessment = true;
                    if (v.includes("M")) maxLevelNum = 3; else if (v.includes("R")) maxLevelNum = Math.max(maxLevelNum, 2); else if (v.includes("I")) maxLevelNum = Math.max(maxLevelNum, 1);
                });
                const m = { 0: "", 1: "I", 2: "R", 3: "M" };
                const base = m[maxLevelNum];
                return base + (base && hasAssessment ? ", A" : hasAssessment ? "A" : "");
            };

            const CreditStepper = ({ label, field, value }) => (
                <div className="space-y-1">
                    <label className="text-[10px] font-bold text-slate-500 uppercase">{label}</label>
                    <div className="flex items-center gap-1 bg-white border border-blue-200 rounded-lg overflow-hidden h-10 shadow-sm">
                        <button onClick={() => handleCreditChange(field, value - 1)} disabled={!canEditThis} className="w-10 h-full hover:bg-red-50 text-red-600 border-r border-blue-100 font-bold disabled:opacity-30">-</button>
                        <div className="flex-1 text-center font-bold text-sm text-blue-700">{value}</div>
                        <button onClick={() => handleCreditChange(field, value + 1)} disabled={!canEditThis} className="w-10 h-full hover:bg-emerald-50 text-emerald-600 border-l border-blue-100 font-bold disabled:opacity-30">+</button>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen flex items-center justify-center italic text-slate-500 animate-pulse">SyllabusPro đang khởi động...</div>;

            return (
                <div className="flex h-screen bg-slate-100 font-inter text-sm select-none">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shrink-0 overflow-hidden shadow-2xl transition-all">
                        <div className="p-6 border-b border-slate-800 flex items-center justify-between">
                            <h1 className="font-bold text-lg text-blue-400 uppercase tracking-tighter">SyllabusPro</h1>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
                            <div className="flex flex-col gap-1 mb-6">
                                {[
                                    { id: 'info', label: '1. Thông tin chung', icon: Icons.Info },
                                    { id: 'objectives', label: '2. Mục tiêu', icon: Icons.Target },
                                    { id: 'clos', label: '3. Chuẩn đầu ra', icon: Icons.CLO },
                                    { id: 'description', label: '4. Mô tả học phần', icon: Icons.Description },
                                    { id: 'structure', label: '5. Cấu trúc học phần', icon: Icons.Layers },
                                    { id: 'teaching', label: '6. Kế hoạch dạy học', icon: Icons.Calendar },
                                    { id: 'assessment', label: '7. Đánh giá', icon: Icons.Assessment },
                                    { id: 'materials', label: '8. Tài liệu', icon: Icons.Materials },
                                    { id: 'regulations', label: '9. Quy định', icon: Icons.User }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => {setActiveTab(tab.id); setIsPreviewMode(false);}} className={`w-full flex items-center gap-3 p-3 rounded-xl text-sm font-medium transition-all ${activeTab === tab.id && !isPreviewMode ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>
                                        <tab.icon /> {tab.label}
                                    </button>
                                ))}
                            </div>
                        </nav>
                        <div className="p-4 bg-slate-800/50 border-t border-slate-800">
                            {user ? <div className="flex items-center gap-2"><img src={user.photoURL} className="w-8 h-8 rounded-full border border-blue-500" /><div className="min-w-0 flex-1"><p className="text-[10px] font-bold truncate">{user.displayName}</p><p className="text-[8px] uppercase text-emerald-400 font-bold">{userRole}</p></div><button onClick={() => window.fb.signOut(fbAuthRef.current)} className="text-slate-500 hover:text-white"><Icons.Logout /></button></div> : <button onClick={handleLogin} className="w-full bg-blue-600 p-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 hover:bg-blue-700 transition-all"><Icons.Google /> Login Gmail</button>}
                        </div>
                    </aside>

                    {/* Main Area */}
                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b p-4 flex justify-between items-center shadow-sm z-50">
                            <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2 uppercase tracking-tight">
                                {syllabus.info.name || "Soạn thảo đề cương"}
                                {syllabus.info.code && <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 font-mono uppercase">{syllabus.info.code}</span>}
                            </h2>
                            <div className="flex gap-2">
                                <button onClick={() => setSyllabus(initialSyllabus)} className="flex items-center gap-2 bg-amber-400 text-amber-900 px-4 py-2 rounded-xl text-xs font-bold hover:bg-amber-500"><Icons.Plus /> Tạo mới</button>
                                <button onClick={handleDuplicate} className="flex items-center gap-2 bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-200"><Icons.Copy /> Nhân bản</button>
                                <button onClick={saveToCloud} disabled={isSaving || !canEditThis} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-700 disabled:opacity-50"><Icons.Save /> {isSaving ? "Đang lưu..." : "Lưu Cloud"}</button>
                                
                                {/* NÚT MỚI THÊM VÀO ĐÂY */}
                                <button onClick={() => setIsPreviewMode(!isPreviewMode)} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold transition-all ${isPreviewMode ? 'bg-amber-500 text-white shadow-lg' : 'bg-white border border-amber-200 text-amber-600 hover:bg-amber-50'}`}>
                                    <Icons.Eye /> {isPreviewMode ? "Đóng Xem trước" : "Chế độ Văn bản"}
                                </button>
                                
                                <button onClick={exportWord} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-700"><Icons.FileText /> Xuất Word</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-10 bg-slate-200/50 custom-scrollbar relative">
                            <div className={`mx-auto bg-white shadow-2xl rounded-3xl border transition-all duration-500 ${isPreviewMode ? 'max-w-4xl preview-mode p-16' : 'max-w-5xl p-12'}`}>
                                
                                {isPreviewMode ? (
                                    <div className="animate-fade-in space-y-4">
                                        <div className="flex justify-between font-bold text-[16px] mb-8">
                                            <div className="text-center"><p>{syllabus.header.schoolName}</p><p>{syllabus.header.department}</p></div>
                                            <div className="text-center"><p>CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</p><p className="border-b-2 border-slate-900 pb-1 inline-block">Độc lập - Tự do - Hạnh phúc</p></div>
                                        </div>
                                        <h1 className="text-center font-bold text-2xl mb-12 uppercase">ĐỀ CƯƠNG HỌC PHẦN</h1>
                                        
                                        <p className="font-bold uppercase text-[18.6px]">I. THÔNG TIN CHUNG ĐỀ CƯƠNG HỌC PHẦN</p>
                                        <div className="indent-line space-y-1">
                                            <p>Học phần: {syllabus.info.name}</p>
                                            <p>Mã học phần: {syllabus.info.code}</p>
                                            <p>Loại học phần: {syllabus.info.type}</p>
                                            <p>Số tín chỉ: {syllabus.info.credits.total}</p>
                                            <p>Số tiết: {syllabus.info.hours.classroom + syllabus.info.hours.exam}</p>
                                        </div>

                                        <p className="font-bold uppercase text-[18.6px] mt-8">II. MỤC TIÊU HỌC PHẦN</p>
                                        <div className="indent-line">
                                            <textarea className="w-full" rows="6" value={syllabus.objectives} onChange={e => setSyllabus({...syllabus, objectives: e.target.value})} />
                                        </div>

                                        <p className="font-bold uppercase text-[18.6px] mt-8">III. CHUẨN ĐẦU RA (CLO)</p>
                                        <table className="w-full border-collapse border border-slate-900 mt-2">
                                            <thead><tr className="bg-slate-50"><th className="border border-slate-900 p-2 w-20">Ký hiệu</th><th className="border border-slate-900 p-2">Nội dung</th></tr></thead>
                                            <tbody>{syllabus.clos.map((c, i) => (<tr key={i}><td className="border border-slate-900 p-2 text-center font-bold">{c.id}</td><td className="border border-slate-900 p-2"><textarea value={c.content} rows="1" onChange={e => { const n=[...syllabus.clos]; n[i].content=e.target.value; setSyllabus({...syllabus, clos:n}); }} /></td></tr>))}</tbody>
                                        </table>

                                        <div className="flex justify-between mt-20 font-bold">
                                            <div className="text-center w-1/2">CHỦ NHIỆM KHOA</div>
                                            <div className="text-center w-1/2"><p className="font-normal italic mb-1">{syllabus.header.city}, ngày... tháng... năm...</p><p>TRƯỞNG BỘ MÔN</p></div>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* GIAO DIỆN NHẬP LIỆU GỐC TỪ V2.HTML */}
                                        {activeTab === 'info' && (
                                            <div className="space-y-8 animate-fade-in">
                                                <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tight">I. Thông tin chung</h3>
                                                <div className="grid grid-cols-2 gap-x-8 gap-y-5">
                                                    <div className="space-y-1 col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tên học phần</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg font-bold outline-none bg-slate-50 focus:bg-white transition-all shadow-inner border-slate-200" value={syllabus.info.name} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, name: e.target.value}})} /></div>
                                                    <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mã học phần</label><input disabled={!canEditThis} className="w-full p-2.5 border rounded-lg uppercase font-mono bg-slate-50 focus:bg-white shadow-inner border-slate-200" value={syllabus.info.code} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, code: e.target.value}})} /></div>
                                                    <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Loại học phần</label><select disabled={!canEditThis} className="w-full p-2.5 border rounded-lg bg-slate-50 outline-none" value={syllabus.info.type} onChange={e => setSyllabus({...syllabus, info: {...syllabus.info, type: e.target.value}})}><option>Bắt buộc</option><option>Tự chọn</option></select></div>
                                                </div>
                                                <div className="bg-blue-50/80 p-8 rounded-[2rem] space-y-8 shadow-inner border border-blue-100 mt-6">
                                                    <div className="grid grid-cols-3 gap-8">
                                                        <CreditStepper label="Tín chỉ Lý thuyết" field="theory" value={syllabus.info.credits.theory} />
                                                        <CreditStepper label="Tín chỉ Thực hành" field="practice" value={syllabus.info.credits.practice} />
                                                        <CreditStepper label="Tín chỉ Thực tập" field="internship" value={syllabus.info.credits.internship} />
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        {activeTab === 'objectives' && (
                                            <div className="space-y-4 animate-fade-in">
                                                <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">II. Mục tiêu học phần</h3>
                                                <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl outline-none text-sm bg-slate-50 font-times" value={syllabus.objectives} onChange={e => setSyllabus({...syllabus, objectives: e.target.value})} />
                                            </div>
                                        )}
                                        {activeTab === 'clos' && (
                                            <div className="space-y-10 animate-fade-in">
                                                <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 mb-4 tracking-tighter">III. Chuẩn đầu ra (CLO)</h3>
                                                {syllabus.clos.map((c, idx) => (
                                                    <div key={idx} className="flex gap-2 mb-2"><input disabled={!canEditThis} className="w-16 p-2 border rounded font-bold text-center uppercase" value={c.id} onChange={e => { const n = [...syllabus.clos]; n[idx].id = e.target.value; setSyllabus({...syllabus, clos: n}) }} /><textarea disabled={!canEditThis} className="flex-1 p-2 border rounded" rows="1" value={c.content} onChange={e => { const n = [...syllabus.clos]; n[idx].content = e.target.value; setSyllabus({...syllabus, clos: n}) }} /></div>
                                                ))}
                                                <button onClick={() => setSyllabus({...syllabus, clos: [...syllabus.clos, {id:`HP${syllabus.clos.length+1}`, content:''}]})}>+ Thêm CLO</button>
                                            </div>
                                        )}
                                        {activeTab === 'structure' && (
                                            <div className="space-y-4 animate-fade-in">
                                                <h3 className="text-lg font-bold uppercase text-slate-800 tracking-tighter">V. Cấu trúc học phần</h3>
                                                <div className="overflow-x-auto border rounded-xl"><table className="w-full text-xs text-left border-collapse"><thead className="bg-slate-50 border-b"><tr><th className="p-2 border-r w-10">STT</th><th className="p-2 border-r">Nội dung</th><th className="p-2 border-r">CĐR</th><th className="p-2 border-r">LT</th><th className="p-2 border-r">TH</th><th className="p-2">Học liệu</th></tr></thead><tbody>{syllabus.structure.map((r, i) => (<tr key={i} className="border-b"><td className="p-2 border-r">{r.stt}</td><td className="p-2 border-r"><input className="w-full" value={r.title} onChange={e => { const n=[...syllabus.structure]; n[i].title=e.target.value; setSyllabus({...syllabus, structure:n}) }} /></td><td className="p-2 border-r">{r.clo}</td><td className="p-2 border-r">{r.lt}</td><td className="p-2 border-r">{r.th}</td><td className="p-2">{r.material}</td></tr>))}</tbody></table><button className="m-2" onClick={() => setSyllabus({...syllabus, structure: [...syllabus.structure, {stt: syllabus.structure.length+1, title:'', clo:'', lt:0, th:0, material:''}]})}>+ Thêm hàng</button></div>
                                            </div>
                                        )}
                                        {activeTab === 'materials' && (
                                            <div className="space-y-4 animate-fade-in">
                                                <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">VIII. Cơ sở vật chất, học liệu</h3>
                                                <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl outline-none text-sm bg-slate-50 font-times" value={syllabus.materials} onChange={e => setSyllabus({...syllabus, materials: e.target.value})} placeholder="Giáo trình, tài liệu tham khảo..." />
                                            </div>
                                        )}
                                        {activeTab === 'regulations' && (
                                            <div className="space-y-4 animate-fade-in">
                                                <h3 className="text-lg font-bold border-b pb-2 uppercase text-slate-800 tracking-tighter">IX. Quy định của học phần</h3>
                                                <textarea disabled={!canEditThis} rows="15" className="w-full p-6 border rounded-2xl outline-none text-sm bg-slate-50 font-times" value={syllabus.regulations} onChange={e => setSyllabus({...syllabus, regulations: e.target.value})} />
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>