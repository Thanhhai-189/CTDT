<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyllabusPro - Khoa Ô tô (Debug Role)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Thư viện Word -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getApps, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Assessment: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBen_GxaeXrll6FSRiegH-Lh1ZXY_a9jrM",
            authDomain: "ctdt-sqkt.firebaseapp.com",
            projectId: "ctdt-sqkt",
            storageBucket: "ctdt-sqkt.firebasestorage.app",
            messagingSenderId: "491495146400",
            appId: "1:491495146400:web:519534d3535d8a8d615ac5",
            measurementId: "G-NDJJCTXVN3"
        };

        function App() {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('checking...'); 
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('info');
            const [syllabus, setSyllabus] = useState({ info: { name: 'Đề cương mới', code: '' }, credits: { theory: 0, practice: 0, internship: 0, total: 0 } });

            const fbAppRef = useRef(null);
            const fbDbRef = useRef(null);
            const fbAuthRef = useRef(null);

            const fetchUserRole = async (u) => {
                if (!u) return;
                const { doc, getDoc } = window.fb;
                try {
                    // Truy vấn TRỰC TIẾP theo UID
                    const userDoc = await getDoc(doc(fbDbRef.current, 'users', u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const allFields = Object.keys(data);
                        
                        // Tìm trường "role" (không phân biệt hoa thường)
                        const roleKey = allFields.find(k => k.trim().toLowerCase() === 'role');
                        const roleValue = roleKey ? data[roleKey] : null;

                        if (roleValue) {
                            setUserRole(roleValue.toString().toLowerCase());
                            console.log("Quyền hạn xác định:", roleValue);
                        } else {
                            // CẢI TIẾN DEBUG: Hiện các trường đang có
                            setUserRole(`guest (Tìm thấy doc nhưng thiếu field 'role'. Đang có: ${allFields.join(', ') || 'trống'})`);
                        }
                    } else {
                        setUserRole(`guest (Không tìm thấy doc với ID: ${u.uid})`);
                    }
                } catch (e) {
                    console.error(e);
                    setUserRole('error: ' + e.message);
                }
            };

            useEffect(() => {
                const { initializeApp, getApps, getAuth, onAuthStateChanged, getFirestore } = window.fb;
                if (!fbAppRef.current) {
                    fbAppRef.current = getApps().length > 0 ? getApps()[0] : initializeApp(FIREBASE_CONFIG);
                    fbDbRef.current = getFirestore(fbAppRef.current);
                    fbAuthRef.current = getAuth(fbAppRef.current);
                }

                const unsubscribe = onAuthStateChanged(fbAuthRef.current, async (u) => {
                    setUser(u);
                    if (u) await fetchUserRole(u);
                    else setUserRole('guest');
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.fb;
                try {
                    await signInWithPopup(fbAuthRef.current, new GoogleAuthProvider());
                } catch (e) { alert(e.message); }
            };

            const handleLogout = async () => {
                await window.fb.signOut(fbAuthRef.current);
                setUserRole('guest');
            };

            const canWrite = userRole === 'admin' || userRole === 'editor';

            if (loading) return <div className="h-screen flex items-center justify-center italic text-slate-500">Đang đồng bộ...</div>;

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-80 bg-slate-900 text-white flex flex-col shrink-0 shadow-2xl">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="font-bold text-xl tracking-tighter text-blue-400">SyllabusPro</h1>
                            <p className="text-[10px] text-slate-500 uppercase mt-1">Hệ thống quản lý đề cương</p>
                        </div>

                        <div className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                             <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h3 className="text-[10px] font-bold text-slate-400 uppercase mb-4">Trạng thái xác thực</h3>
                                {user ? (
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3">
                                            <img src={user.photoURL} className="w-10 h-10 rounded-full border-2 border-blue-500/30" alt="avatar" />
                                            <div className="min-w-0">
                                                <p className="text-xs font-bold truncate">{user.displayName}</p>
                                                <div className="flex items-center gap-1">
                                                    <span className={`text-[9px] px-2 py-0.5 rounded font-bold uppercase ${canWrite ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                                                        {userRole.includes('guest') ? 'Khách' : userRole}
                                                    </span>
                                                    <button onClick={() => fetchUserRole(user)} className="hover:text-blue-400 p-1"><Icons.Refresh /></button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {userRole.includes('guest') && (
                                            <div className="p-2 bg-red-900/20 border border-red-500/30 rounded text-[9px] text-red-300 leading-relaxed">
                                                <p className="font-bold mb-1 underline">HƯỚNG DẪN FIX:</p>
                                                {userRole.includes('no-doc') ? (
                                                    <span>ID tài liệu trong Firestore chưa khớp UID bên dưới. Vui lòng tạo doc với ID chính xác là UID.</span>
                                                ) : (
                                                    <span>Tìm thấy tài liệu nhưng thiếu trường 'role'. Hãy thêm field 'role' kiểu string.</span>
                                                )}
                                            </div>
                                        )}

                                        <div className="pt-2 border-t border-slate-800 flex flex-col gap-1">
                                            <p className="text-[8px] text-slate-600 uppercase font-bold tracking-widest">Auth UID (Dùng làm Doc ID):</p>
                                            <code className="text-[9px] bg-black/30 p-1.5 rounded text-blue-300 select-all block break-all font-mono leading-tight border border-white/5">
                                                {user.uid}
                                            </code>
                                            <button onClick={() => {
                                                const el = document.createElement('textarea'); el.value = user.uid; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("Đã copy UID!");
                                            }} className="text-[9px] text-slate-500 hover:text-white mt-1 text-left italic">→ Nhấn để copy UID</button>
                                        </div>

                                        <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-red-900/30 py-2 rounded-lg text-xs font-bold transition-all border border-slate-700 mt-2">
                                            <Icons.Logout /> Đăng xuất
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={handleLogin} className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-900/20 transition-all">
                                        <Icons.Google /> Login with Gmail
                                    </button>
                                )}
                             </div>
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
                             <nav className="flex gap-8">
                                {['info', 'objectives', 'structure', 'assessment'].map(t => (
                                    <button key={t} onClick={() => setActiveTab(t)} className={`text-sm font-bold pb-2 border-b-2 transition-all capitalize ${activeTab === t ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400'}`}>
                                        {t === 'info' ? 'Thông tin' : t === 'objectives' ? 'Mục tiêu' : t === 'structure' ? 'Cấu trúc' : 'Đánh giá'}
                                    </button>
                                ))}
                             </nav>
                             <button disabled={!canWrite} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold text-xs shadow transition-all ${!canWrite ? 'bg-slate-200 text-slate-400' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                <Icons.Save /> Lưu Cloud
                             </button>
                        </header>

                        <div className="flex-1 overflow-y-auto p-12 custom-scrollbar animate-fade-in">
                            <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl border border-slate-200 p-12 min-h-full relative">
                                {!canWrite && user && (
                                    <div className="absolute top-4 right-6 bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1 rounded-full text-[10px] font-bold z-10 animate-bounce">
                                        CHẾ ĐỘ XEM (READ-ONLY)
                                    </div>
                                )}
                                <h2 className="text-2xl font-bold text-slate-800 mb-8 border-b pb-4">Nội dung đề cương</h2>
                                <p className="text-slate-500 italic">Vui lòng đăng nhập với quyền Admin hoặc Editor để chỉnh sửa nội dung này.</p>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>