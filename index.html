<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyllabusPro V2.2 - Quản lý Quyền sở hữu</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Thư viện xử lý Word -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getApps, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .font-times { font-family: "Times New Roman", Times, serif; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Layers: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Assessment: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            Minus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>,
            Logout: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBen_GxaeXrll6FSRiegH-Lh1ZXY_a9jrM",
            authDomain: "ctdt-sqkt.firebaseapp.com",
            projectId: "ctdt-sqkt",
            storageBucket: "ctdt-sqkt.firebasestorage.app",
            messagingSenderId: "491495146400",
            appId: "1:491495146400:web:519534d3535d8a8d615ac5",
            measurementId: "G-NDJJCTXVN3"
        };

        const initialSyllabus = {
            id: '',
            ownerUid: '', // Thêm để định danh người tạo
            ownerEmail: '', // Thêm để hiển thị
            header: { schoolName: 'TRƯỜNG SĨ QUAN KTQS', department: 'KHOA Ô TÔ', city: 'Thành phố Hồ Chí Minh', year: '2025' },
            info: { 
                name: 'Hệ thống điện - điện tử ô tô', 
                code: '', 
                major: 'Kỹ thuật ô tô', 
                type: 'Bắt buộc', 
                prerequisites: '', 
                parallel: 'Không', 
                contact: 'Khoa Ô tô', 
                credits: { theory: 0, practice: 0, internship: 0, total: 0 }, 
                hours: { total: 0, classroom: 0, theory: 0, practice: 0, internship: 0, exam: 0, selfStudy: 0 } 
            },
            objectives: '',
            clos: [{ id: 'HP1', content: '' }],
            cloMatrix: { plos: ['KT 1', 'KT 2', 'KN 1', 'KN 2'], mapping: {} },
            structure: [],
            assessments: [{ code: 'A1.1', type: 'Thường xuyên', method: 'Vấn đáp', weight: '10%', clo: 'HP1' }],
            materials: '',
            regulations: ''
        };

        function App() {
            const [syllabus, setSyllabus] = useState(initialSyllabus);
            const [savedSyllabi, setSavedSyllabi] = useState([]);
            const [activeTab, setActiveTab] = useState('info');
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState('checking...'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [authError, setAuthError] = useState(null);
            
            const fbAppRef = useRef(null);
            const fbDbRef = useRef(null);
            const fbAuthRef = useRef(null);

            const fetchUserRole = async (u) => {
                if (!u) return;
                const { doc, getDoc } = window.fb;
                try {
                    const userDoc = await getDoc(doc(fbDbRef.current, 'users', u.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const roleKey = Object.keys(data).find(k => k.trim().toLowerCase() === 'role');
                        const role = roleKey ? data[roleKey] : null;
                        setUserRole(role ? role.toString().toLowerCase() : 'guest');
                    } else {
                        setUserRole('guest');
                    }
                } catch (e) {
                    console.error("Firestore Error:", e);
                    setUserRole('error');
                }
            };

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const { initializeApp, getApps, getAuth, onAuthStateChanged, getFirestore } = window.fb;
                        if (!fbAppRef.current) {
                            fbAppRef.current = getApps().length > 0 ? getApps()[0] : initializeApp(FIREBASE_CONFIG);
                            fbDbRef.current = getFirestore(fbAppRef.current);
                            fbAuthRef.current = getAuth(fbAppRef.current);
                        }

                        onAuthStateChanged(fbAuthRef.current, async (u) => {
                            setUser(u);
                            if (u) {
                                setAuthError(null);
                                await fetchUserRole(u);
                            } else {
                                setUserRole('guest');
                            }
                            setLoading(false);
                        });
                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !fbDbRef.current) return;
                const { collection, onSnapshot } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const q = collection(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSavedSyllabi(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [user]);

            // LOGIC PHÂN QUYỀN TRÊN TÀI LIỆU HIỆN TẠI
            const isAdmin = userRole === 'admin';
            const isEditor = userRole === 'editor';
            const isOwner = syllabus.ownerUid === user?.uid || syllabus.ownerUid === ''; // Trống nghĩa là đang tạo mới
            
            // Quyền sửa/xóa học phần cụ thể
            const canEditThis = isAdmin || (isEditor && isOwner);
            // Quyền tạo mới học phần (Chỉ cần là admin hoặc editor)
            const canCreate = isAdmin || isEditor;

            const handleCreateNew = () => {
                const freshSyllabus = JSON.parse(JSON.stringify(initialSyllabus));
                setSyllabus(freshSyllabus);
                setActiveTab('info');
            };

            const handleDuplicate = () => {
                if (!syllabus.info.code) return alert("Học phần hiện tại chưa có mã để nhân bản.");
                
                const duplicated = JSON.parse(JSON.stringify(syllabus));
                duplicated.info.code = `${duplicated.info.code}-copy`;
                duplicated.id = ''; 
                duplicated.ownerUid = user.uid; // Người nhân bản trở thành chủ sở hữu bản sao
                duplicated.ownerEmail = user.email;
                setSyllabus(duplicated);
                setActiveTab('info');
                alert("Đã tạo bản sao thành công! Bạn hiện là chủ sở hữu của bản sao này.");
            };

            const handleLogin = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.fb;
                const provider = new GoogleAuthProvider();
                try {
                    setAuthError(null);
                    await signInWithPopup(fbAuthRef.current, provider);
                } catch (e) {
                    if (e.code === 'auth/unauthorized-domain') setAuthError(window.location.hostname);
                    else alert(e.message);
                }
            };

            const handleLogout = async () => {
                await window.fb.signOut(fbAuthRef.current);
                setUserRole('guest');
            };

            const handleCreditChange = (field, value) => {
                const val = Math.max(0, parseFloat(value) || 0);
                setSyllabus(prev => {
                    const newCredits = { ...prev.info.credits, [field]: val };
                    newCredits.total = (newCredits.theory || 0) + (newCredits.practice || 0) + (newCredits.internship || 0);
                    const newHours = { ...prev.info.hours };
                    newHours.theory = newCredits.theory * 15;
                    newHours.practice = newCredits.practice * 30;
                    newHours.internship = newCredits.internship * 45;
                    newHours.classroom = newHours.theory + newHours.practice + newHours.internship;
                    newHours.total = newHours.classroom + newHours.exam;
                    newHours.selfStudy = newCredits.total * 30;
                    return { ...prev, info: { ...prev.info, credits: newCredits, hours: newHours } };
                });
            };

            const saveToCloud = async () => {
                if (!user) return alert("Vui lòng đăng nhập.");
                if (!canEditThis) return alert("Bạn không có quyền chỉnh sửa học phần này (Chỉ chủ sở hữu hoặc Admin mới có quyền).");
                if (!syllabus.info.code) return alert("Vui lòng nhập Mã học phần trước khi lưu.");
                
                setIsSaving(true);
                const { doc, setDoc } = window.fb;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app';
                const docId = syllabus.info.code;

                // Nếu là tài liệu mới, gán chủ sở hữu là người đang đăng nhập
                const dataToSave = { ...syllabus };
                if (!dataToSave.ownerUid) {
                    dataToSave.ownerUid = user.uid;
                    dataToSave.ownerEmail = user.email;
                }
                
                try {
                    await setDoc(doc(fbDbRef.current, 'artifacts', appId, 'public', 'data', 'syllabi', docId), { 
                        ...dataToSave, 
                        id: docId, 
                        updatedAt: new Date().toISOString() 
                    });
                    alert("Đã lưu dữ liệu thành công!");
                    setSyllabus(dataToSave); // Cập nhật lại state cục bộ để UI nhận biết owner
                } catch (e) { 
                    alert("Lỗi lưu Cloud: " + e.message); 
                }
                setIsSaving(false);
            };

            const exportWord = () => {
                const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel } = window.docx;
                const docObj = new Document({
                    sections: [{
                        children: [
                            new Paragraph({ text: syllabus.header.schoolName, bold: true, alignment: AlignmentType.CENTER }),
                            new Paragraph({ text: "ĐỀ CƯƠNG HỌC PHẦN", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { before: 400, after: 400 } }),
                            new Paragraph({ children: [new TextRun({ text: "I. THÔNG TIN CHUNG", bold: true })] }),
                            new Paragraph({ text: `Học phần: ${syllabus.info.name}` }),
                            new Paragraph({ text: `Mã học phần: ${syllabus.info.code}` }),
                        ]
                    }]
                });
                Packer.toBlob(docObj).then(blob => { window.saveAs(blob, `De_cuong_${syllabus.info.code || 'moi'}.docx`); });
            };

            const CreditStepper = ({ label, field, value }) => (
                <div className="space-y-1">
                    <label className="text-[10px] font-bold text-slate-500 uppercase">{label}</label>
                    <div className="flex items-center gap-1 bg-white border border-blue-200 rounded-lg overflow-hidden h-10 shadow-sm">
                        <button onClick={() => handleCreditChange(field, value - 1)} disabled={!canEditThis} className="w-10 h-full bg-slate-50 hover:bg-red-50 text-red-600 border-r border-blue-100 disabled:opacity-30"><Icons.Minus /></button>
                        <div className="flex-1 text-center font-bold text-sm text-blue-700">{value}</div>
                        <button onClick={() => handleCreditChange(field, value + 1)} disabled={!canEditThis} className="w-10 h-full bg-slate-50 hover:bg-emerald-50 text-emerald-600 border-l border-blue-100 disabled:opacity-30"><Icons.Plus /></button>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen flex items-center justify-center italic text-slate-500 animate-pulse">Đang đồng bộ quyền hạn...</div>;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100 font-inter text-slate-900">
                    <aside className="w-72 bg-slate-900 text-white flex flex-col shrink-0 no-print">
                        <div className="p-6 border-b border-slate-800">
                            <div className="flex items-center gap-2 mb-6 text-blue-400">
                                <h1 className="font-bold text-lg text-white tracking-tighter uppercase">SyllabusPro</h1>
                            </div>
                            <div className="flex flex-col gap-2">
                                <button onClick={handleCreateNew} disabled={!canCreate} className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 py-3 rounded-xl text-xs font-bold transition-all shadow-lg active:scale-95 disabled:opacity-30">
                                    <Icons.Plus /> Tạo học phần mới
                                </button>
                                <button onClick={handleDuplicate} disabled={!syllabus.info.code || !canCreate} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-xs font-bold transition-all shadow-lg active:scale-95 border border-slate-700 disabled:opacity-30">
                                    <Icons.Copy /> Nhân bản
                                </button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-2 bg-slate-900/50">
                            <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-2">Học phần trên Cloud</h3>
                            {!user ? (
                                <button onClick={handleLogin} className="flex items-center justify-center gap-2 w-full bg-white text-slate-900 py-2 rounded-lg text-xs font-bold hover:bg-slate-100"><Icons.Google /> Login Gmail</button>
                            ) : (
                                savedSyllabi.map(item => (
                                    <div key={item.id} onClick={() => setSyllabus(item)} className={`group relative p-3 rounded-xl cursor-pointer border transition-all ${syllabus.id === item.id ? 'bg-slate-800 border-blue-500/50 shadow-inner' : 'border-transparent hover:bg-slate-800/50'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="min-w-0 flex-1">
                                                <p className="text-xs font-bold truncate text-slate-200">{item.info.name}</p>
                                                <p className="text-[10px] text-slate-500">{item.info.code}</p>
                                            </div>
                                            {(isAdmin || (isEditor && item.ownerUid === user.uid)) && (
                                                <button onClick={(e) => { e.stopPropagation(); if(confirm("Xóa học phần này?")) window.fb.deleteDoc(window.fb.doc(fbDbRef.current, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'ctdt-sqkt-app', 'public', 'data', 'syllabi', item.id)); }} className="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-500 p-1 transition-opacity"><Icons.Trash /></button>
                                            )}
                                        </div>
                                        {/* Hiển thị chủ sở hữu */}
                                        <div className="flex items-center gap-1 mt-2 text-[8px] text-slate-600 italic">
                                            <Icons.User /> {item.ownerEmail === user.email ? "Tôi" : (item.ownerEmail || "Không rõ")}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-800 bg-slate-900">
                            {user ? (
                                <div className="space-y-2">
                                    <div className="flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                                        <img src={user.photoURL} alt="avatar" className="w-8 h-8 rounded-full border border-blue-500/50 shadow-md" />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-[10px] font-bold truncate text-slate-100">{user.displayName}</p>
                                            <div className="flex items-center gap-1">
                                                <p className={`text-[9px] font-bold uppercase ${isAdmin || isEditor ? 'text-emerald-400' : 'text-amber-400'}`}>{userRole}</p>
                                                <button onClick={() => fetchUserRole(user)} className="text-slate-500 hover:text-white"><Icons.Refresh /></button>
                                            </div>
                                        </div>
                                        <button onClick={handleLogout} className="text-slate-500 hover:text-white"><Icons.Logout /></button>
                                    </div>
                                    <p className="text-[8px] text-slate-600 truncate px-1 opacity-50 select-all font-mono">UID: {user.uid}</p>
                                </div>
                            ) : (
                                <button onClick={handleLogin} className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold text-xs active:scale-95"><Icons.Google /> Đăng nhập Gmail</button>
                            )}
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm no-print">
                            <nav className="flex gap-8">
                                {[
                                    { id: 'info', label: 'Thông tin chung', icon: Icons.Info },
                                    { id: 'objectives', label: 'Mục tiêu & CĐR', icon: Icons.Target },
                                    { id: 'structure', label: 'Cấu trúc bài', icon: Icons.Layers },
                                    { id: 'assessment', label: 'Đánh giá', icon: Icons.Assessment }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center gap-2 text-sm font-bold pb-2 transition-all border-b-2 ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                        <tab.icon /> {tab.label}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-4">
                                <button onClick={saveToCloud} disabled={isSaving || !canEditThis} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold text-xs shadow active:scale-95 ${!canEditThis ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    <Icons.Save /> {isSaving ? 'Đang lưu...' : 'Lưu Cloud'}
                                </button>
                                <button onClick={exportWord} className="flex items-center gap-2 bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold text-xs hover:bg-emerald-700 shadow active:scale-95"><Icons.FileText /> Word</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-10 custom-scrollbar font-times animate-fade-in">
                            <div className="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl border border-slate-200 p-12 min-h-full relative overflow-hidden">
                                
                                {/* UI LOCKING OVERLAY / BADGE */}
                                {user && (
                                    <div className="absolute top-4 right-4 flex gap-2 z-10">
                                        {syllabus.ownerEmail && (
                                            <div className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1 rounded-full text-[10px] font-bold shadow-sm flex items-center gap-1">
                                                <Icons.User /> Chủ sở hữu: {syllabus.ownerEmail === user.email ? "Bạn" : syllabus.ownerEmail}
                                            </div>
                                        )}
                                        {!canEditThis && (
                                            <div className="bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1 rounded-full text-[10px] font-bold shadow-sm">
                                                Chỉ xem (Read-Only)
                                            </div>
                                        )}
                                    </div>
                                )}

                                {activeTab === 'info' && (
                                    <div className="space-y-8 animate-fade-in">
                                        <h2 className="text-xl font-bold border-b pb-2 uppercase tracking-tight text-slate-800">I. Thông tin chung học phần</h2>
                                        <div className="grid grid-cols-2 gap-x-8 gap-y-4">
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Học phần</label><input disabled={!canEditThis} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold outline-none focus:ring-1 focus:ring-blue-400" value={syllabus.info.name} onChange={(e) => setSyllabus({...syllabus, info: {...syllabus.info, name: e.target.value}})} /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Mã học phần</label><input disabled={!canEditThis} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-1 focus:ring-blue-400 outline-none uppercase font-mono" value={syllabus.info.code} onChange={(e) => setSyllabus({...syllabus, info: {...syllabus.info, code: e.target.value}})} placeholder="OTO2025" /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Chuyên ngành</label><input disabled={!canEditThis} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-1 focus:ring-blue-400 outline-none" value={syllabus.info.major} onChange={(e) => setSyllabus({...syllabus, info: {...syllabus.info, major: e.target.value}})} /></div>
                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase">Loại</label><select disabled={!canEditThis} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none" value={syllabus.info.type} onChange={(e) => setSyllabus({...syllabus, info: {...syllabus.info, type: e.target.value}})}><option>Bắt buộc</option><option>Tự chọn</option></select></div>
                                            <div className="space-y-1 col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase">Khoa/Bộ môn phụ trách</label><input disabled={!canEditThis} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-400" value={syllabus.info.contact} onChange={(e) => setSyllabus({...syllabus, info: {...syllabus.info, contact: e.target.value}})} /></div>
                                        </div>
                                        <div className="mt-8 pt-6 border-t border-slate-100 bg-blue-50/30 p-6 rounded-3xl space-y-6 shadow-inner">
                                            <h3 className="text-sm font-bold text-blue-800 italic underline uppercase tracking-tighter">Cấu trúc Tín chỉ và Số tiết:</h3>
                                            <div className="grid grid-cols-4 gap-6">
                                                <CreditStepper label="TC Lý thuyết" field="theory" value={syllabus.info.credits.theory} />
                                                <CreditStepper label="TC Thực hành" field="practice" value={syllabus.info.credits.practice} />
                                                <CreditStepper label="TC Thực tập/BTL" field="internship" value={syllabus.info.credits.internship} />
                                                <div className="space-y-1 text-center"><label className="text-[10px] font-bold text-blue-600 uppercase">Tổng TC</label><div className="flex items-center justify-center h-10 bg-blue-600 text-white font-bold rounded-lg shadow-md border border-blue-700">{syllabus.info.credits.total}</div></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-6 pt-4 border-t border-blue-100">
                                                <div className="space-y-1"><label className="text-[10px] font-bold text-blue-500 uppercase">+ Lý thuyết</label><div className="p-2 bg-white border border-slate-200 rounded-lg text-center font-medium shadow-inner">{syllabus.info.hours.theory}</div></div>
                                                <div className="space-y-1 col-span-2"><label className="text-[10px] font-bold text-emerald-600 uppercase">+ Thực hành, thí nghiệm, thảo luận</label><div className="p-2 bg-white border border-slate-200 rounded-lg text-center font-bold text-emerald-700 shadow-inner">{syllabus.info.hours.practice + syllabus.info.hours.internship}</div></div>
                                                <div className="space-y-1 text-center"><label className="text-[10px] font-bold text-red-500 uppercase">Tổng tiết học</label><div className="p-2 bg-red-100 text-red-700 font-bold rounded-lg border border-red-200 shadow-sm">{syllabus.info.hours.total}</div></div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'objectives' && (
                                    <div className="space-y-10 animate-fade-in">
                                        <section className="space-y-6">
                                            <h2 className="text-xl font-bold border-b pb-2 uppercase tracking-tight text-slate-800">II. Mục tiêu & III. Chuẩn đầu ra</h2>
                                            <textarea disabled={!canEditThis} rows="4" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-1 focus:ring-blue-400 text-sm leading-relaxed" value={syllabus.objectives} onChange={(e) => setSyllabus({...syllabus, objectives: e.target.value})} placeholder="Nhập mục tiêu học phần..." />
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-center font-bold text-xs uppercase text-slate-400 tracking-widest">Danh sách CLO <button disabled={!canEditThis} onClick={() => setSyllabus({...syllabus, clos: [...syllabus.clos, {id: `HP${syllabus.clos.length+1}`, content: ''}]})} className="text-blue-600 hover:underline">+ Thêm</button></div>
                                                {syllabus.clos.map((clo, idx) => (
                                                    <div key={idx} className="flex gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200 group hover:border-blue-200 transition-colors">
                                                        <input disabled={!canEditThis} className="w-20 p-2 bg-white border rounded-lg text-xs font-bold text-center uppercase" value={clo.id} onChange={(e) => { const n = [...syllabus.clos]; n[idx].id = e.target.value; setSyllabus({...syllabus, clos: n}); }} />
                                                        <textarea disabled={!canEditThis} className="flex-1 p-2 bg-white border rounded-lg text-xs outline-none" rows="1" value={clo.content} onChange={(e) => { const n = [...syllabus.clos]; n[idx].content = e.target.value; setSyllabus({...syllabus, clos: n}); }} placeholder="Chuẩn đầu ra học phần..." />
                                                        {canEditThis && <button onClick={() => setSyllabus({...syllabus, clos: syllabus.clos.filter((_, i) => i !== idx)})} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Icons.Trash /></button>}
                                                    </div>
                                                ))}
                                            </div>
                                        </section>
                                        <section className="space-y-6 pt-10 border-t border-slate-100">
                                            <h3 className="text-lg font-bold uppercase text-slate-700 tracking-tighter italic">IV. Ma trận đóng góp CLO đối với PLO:</h3>
                                            <div className="overflow-x-auto border rounded-2xl shadow-sm">
                                                <table className="w-full text-xs text-left border-collapse">
                                                    <thead className="bg-slate-50 border-b">
                                                        <tr>
                                                            <th className="p-4 border-r min-w-[120px] font-bold text-slate-600">CĐR HP</th>
                                                            {syllabus.cloMatrix.plos.map((plo, idx) => <th key={idx} className="p-2 text-center border-r font-bold text-blue-600 bg-blue-50/30 uppercase">{plo}</th>)}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {syllabus.clos.map((clo, cIdx) => (
                                                            <tr key={cIdx} className="border-b hover:bg-slate-50 transition-colors">
                                                                <td className="p-4 border-r font-bold text-slate-800 bg-slate-50/50">{clo.id}</td>
                                                                {syllabus.cloMatrix.plos.map((plo, pIdx) => (
                                                                    <td key={pIdx} className="p-0 border-r text-center">
                                                                        <input disabled={!canEditThis} className="w-full text-center outline-none p-3 focus:bg-blue-50 uppercase font-medium" placeholder="-" value={syllabus.cloMatrix.mapping?.[clo.id]?.[plo] || ''} onChange={(e) => {
                                                                            const val = e.target.value;
                                                                            setSyllabus(prev => ({
                                                                                ...prev,
                                                                                cloMatrix: {
                                                                                    ...prev.cloMatrix,
                                                                                    mapping: { ...prev.cloMatrix.mapping, [clo.id]: { ...prev.cloMatrix.mapping[clo.id], [plo]: val } }
                                                                                }
                                                                            }));
                                                                        }} />
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </section>
                                    </div>
                                )}

                                {activeTab === 'structure' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="flex justify-between items-center"><h2 className="text-xl font-bold uppercase border-b pb-2 tracking-tight text-slate-800">V. Cấu trúc bài học</h2><button disabled={!canEditThis} onClick={() => setSyllabus({...syllabus, structure: [...syllabus.structure, {stt: syllabus.structure.length+1, title: '', clo: 'HP1', lt: 0, th: 0}]})} className="text-xs bg-blue-600 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all">+ Thêm bài</button></div>
                                        <div className="border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                                            <table className="w-full text-xs text-left border-collapse">
                                                <thead className="bg-slate-50 font-bold border-b text-slate-600 uppercase">
                                                    <tr><th className="p-4 w-12 text-center border-r">STT</th><th className="p-4 border-r">Nội dung</th><th className="p-4 w-16 text-center border-r">CĐR</th><th className="p-4 w-12 text-center border-r">LT</th><th className="p-4 w-12 text-center border-r">TH</th><th className="p-4 w-10"></th></tr>
                                                </thead>
                                                <tbody>
                                                    {syllabus.structure.map((row, idx) => (
                                                        <tr key={idx} className="border-b hover:bg-slate-50/50 transition-colors">
                                                            <td className="p-4 font-bold text-center text-slate-400 border-r bg-slate-50/30">{row.stt}</td>
                                                            <td className="p-4 border-r"><input disabled={!canEditThis} className="w-full outline-none bg-transparent font-medium" value={row.title} onChange={(e) => { const n = [...syllabus.structure]; n[idx].title = e.target.value; setSyllabus({...syllabus, structure: n}); }} placeholder="Tên bài học..." /></td>
                                                            <td className="p-4 text-center border-r uppercase"><input disabled={!canEditThis} className="w-full text-center outline-none bg-transparent font-bold text-blue-600" value={row.clo} onChange={(e) => { const n = [...syllabus.structure]; n[idx].clo = e.target.value; setSyllabus({...syllabus, structure: n}); }} /></td>
                                                            <td className="p-4 text-center border-r"><input disabled={!canEditThis} type="number" className="w-full text-center outline-none bg-transparent" value={row.lt} onChange={(e) => { const n = [...syllabus.structure]; n[idx].lt = parseInt(e.target.value)||0; setSyllabus({...syllabus, structure: n}); }} /></td>
                                                            <td className="p-4 text-center border-r"><input disabled={!canEditThis} type="number" className="w-full text-center outline-none bg-transparent" value={row.th} onChange={(e) => { const n = [...syllabus.structure]; n[idx].th = parseInt(e.target.value)||0; setSyllabus({...syllabus, structure: n}); }} /></td>
                                                            <td className="p-4 text-center">{canEditThis && <button onClick={() => setSyllabus({...syllabus, structure: syllabus.structure.filter((_, i) => i !== idx)})} className="text-slate-300 hover:text-red-500 transition-all"><Icons.Trash /></button>}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'assessment' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="flex justify-between items-center"><h2 className="text-xl font-bold uppercase border-b pb-2 tracking-tight text-slate-800">VII. Đánh giá học phần</h2><button disabled={!canEditThis} onClick={() => setSyllabus({...syllabus, assessments: [...syllabus.assessments, {code: `A${syllabus.assessments.length+1}.1`, type: '', weight: '10%'}]})} className="text-xs bg-blue-600 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all">+ Thêm tiêu chí</button></div>
                                        <div className="grid grid-cols-1 gap-4">
                                            {syllabus.assessments.map((ass, idx) => (
                                                <div key={idx} className="flex gap-4 items-center bg-slate-50 p-5 rounded-2xl border border-slate-200 group hover:border-blue-300 transition-all shadow-sm">
                                                    <div className="w-20"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Mã</label><input disabled={!canEditThis} className="w-full p-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-center uppercase shadow-inner" value={ass.code} onChange={(e) => { const n = [...syllabus.assessments]; n[idx].code = e.target.value; setSyllabus({...syllabus, assessments: n}); }} /></div>
                                                    <div className="flex-1"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Hình thức đánh giá</label><input disabled={!canEditThis} className="w-full p-2 bg-white border border-slate-200 rounded-lg text-xs font-medium shadow-inner" placeholder="Thi kết thúc, Vấn đáp..." value={ass.type} onChange={(e) => { const n = [...syllabus.assessments]; n[idx].type = e.target.value; setSyllabus({...syllabus, assessments: n}); }} /></div>
                                                    <div className="w-24"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1 text-center">Trọng số</label><input disabled={!canEditThis} className="w-full p-2 bg-white border border-slate-200 rounded-lg text-xs text-center font-bold text-blue-600 shadow-inner" value={ass.weight} onChange={(e) => { const n = [...syllabus.assessments]; n[idx].weight = e.target.value; setSyllabus({...syllabus, assessments: n}); }} /></div>
                                                    {canEditThis && <button onClick={() => setSyllabus({...syllabus, assessments: syllabus.assessments.filter((_, i) => i !== idx)})} className="mt-5 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Icons.Trash /></button>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>